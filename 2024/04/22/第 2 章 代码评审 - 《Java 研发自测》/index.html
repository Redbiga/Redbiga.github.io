<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>第 2 章 代码评审 - 《Java 研发自测》 | 山麋一笑</title><meta name="author" content="山麋一笑"><meta name="copyright" content="山麋一笑"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="在软件开发过程中，除了可以从功能角度发现问题以外，还可以通过代码检视发现一些显而易见的问题，做好这部分工作带来的收益甚至比测试人员手动测试还高。在实践中，对代码进行评审可以从如下三个层面把控：  静态代码分析。 每日代码评审。 代码合入请求。  **静态代码分析 ** 是指在代码提交时使用工具自动扫描，或者在流水线中让构建服务器代为扫描。一般来说，大的公司会有专门的部门采购各种代码分析工具，我们可">
<meta property="og:type" content="article">
<meta property="og:title" content="第 2 章 代码评审 - 《Java 研发自测》">
<meta property="og:url" content="http://www.bojiboqi.fun/2024/04/22/%E7%AC%AC%202%20%E7%AB%A0%20%E4%BB%A3%E7%A0%81%E8%AF%84%E5%AE%A1%20-%20%E3%80%8AJava%20%E7%A0%94%E5%8F%91%E8%87%AA%E6%B5%8B%E3%80%8B/index.html">
<meta property="og:site_name" content="山麋一笑">
<meta property="og:description" content="在软件开发过程中，除了可以从功能角度发现问题以外，还可以通过代码检视发现一些显而易见的问题，做好这部分工作带来的收益甚至比测试人员手动测试还高。在实践中，对代码进行评审可以从如下三个层面把控：  静态代码分析。 每日代码评审。 代码合入请求。  **静态代码分析 ** 是指在代码提交时使用工具自动扫描，或者在流水线中让构建服务器代为扫描。一般来说，大的公司会有专门的部门采购各种代码分析工具，我们可">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://www.bojiboqi.fun/img/wakawaka/IMG_20240309_203909_595.webp">
<meta property="article:published_time" content="2024-04-22T06:29:33.315Z">
<meta property="article:modified_time" content="2024-04-22T23:26:57.697Z">
<meta property="article:author" content="山麋一笑">
<meta property="article:tag" content="spring测试">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://www.bojiboqi.fun/img/wakawaka/IMG_20240309_203909_595.webp"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://www.bojiboqi.fun/2024/04/22/%E7%AC%AC%202%20%E7%AB%A0%20%E4%BB%A3%E7%A0%81%E8%AF%84%E5%AE%A1%20-%20%E3%80%8AJava%20%E7%A0%94%E5%8F%91%E8%87%AA%E6%B5%8B%E3%80%8B/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta/><link rel="stylesheet" href="/css/index.css?v=4.12.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.32/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.0/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '第 2 章 代码评审 - 《Java 研发自测》',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-04-23 07:26:57'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 6 || hour >= 18
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/transpancy.css"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="山麋一笑" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load',() => { preloader.endLoading() })

  if (true) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
})()</script><div id="web_bg" style="background:url(/img/wakawaka/IMG_20240309_203909_595.webp);background-attachment: local;background-position: center;background-size: cover;background-repeat: no-repeat;"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "/images/1.webp" data-lazy-src="/img/favicon.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">124</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">58</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">23</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/photo/"><i class="fa-fw fas fa-list"></i><span> 图库</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/wakawaka/IMG_20240309_203909_595.webp')"><nav id="nav"><span id="blog-info"><a href="/" title="山麋一笑"><span class="site-name">山麋一笑</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/photo/"><i class="fa-fw fas fa-list"></i><span> 图库</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">第 2 章 代码评审 - 《Java 研发自测》</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-04-22T06:29:33.315Z" title="发表于 2024-04-22 14:29:33">2024-04-22</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-04-22T23:26:57.697Z" title="更新于 2024-04-23 07:26:57">2024-04-23</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%B5%8B%E8%AF%95/">测试</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">17.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>66分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="第 2 章 代码评审 - 《Java 研发自测》"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>在软件开发过程中，除了可以从功能角度发现问题以外，还可以通过代码检视发现一些显而易见的问题，做好这部分工作带来的收益甚至比测试人员手动测试还高。<br />在实践中，对代码进行评审可以从如下三个层面把控：</p>
<ul>
<li>静态代码分析。</li>
<li>每日代码评审。</li>
<li>代码合入请求。</li>
</ul>
<p>**静态代码分析 ** 是指在代码提交时使用工具自动扫描，或者在流水线中让构建服务器代为扫描。一般来说，大的公司会有专门的部门采购各种代码分析工具，我们可以从代码风格、潜在的缺陷、合规和安全等方面系统地检查代码中存在的问题。扫描不合格的代码不予发布，避免为产品带来潜在的风险。<br />**每日代码评审 ** 是指团队每日一起评审当日或上一日的代码，一般在下午下班前进行，时间需要控制在 30～60 分钟。每日代码评审除了可以用于提高代码质量以外，也可以用于团队的技术交流和问题沟通，毕竟大家工作在同一个代码仓库里。<br />代码评审一般由人工完成，可使用 Git、GitLab、IntelliJ IDEA 等工具。代码评审作为静态代码分析的补充方法，一般不会涉及已经被静态代码分析所覆盖的内容。<br />**代码合入请求 ** 是指在必要时通过合入请求来合入代码。具体合入方式取决于团队使用的 Git 工作流，一般敏捷团队会使用主干开发的方式。在一个新的迭代开启后，团队会在主干上开发、提交代码，并且会在需要发布的时候创建一个 Release 分支来冻结代码。代码冻结后，如果还有缺陷需要修复，为了保证测试的可靠性，避免多次全量回归，就需要通过合入请求来合入。<br />上述每一个层面都有不同的价值，它们不仅可以合理管理代码质量，还能做到不打扰开发人员的日常工作，不增加额外的负担。<br />本章将围绕这三个层面展开，目标是基于对代码的静态代码分析、人工检查等方法来提高代码质量，涵盖的内容如下：</p>
<ul>
<li>静态代码分析。</li>
<li>人工代码评审的方法和实践。</li>
<li>Git 工作流。<br>
<a name="SXtDN"></a></li>
</ul>
<h2 id="2-1-常用的静态代码分析工具">2.1 常用的静态代码分析工具</h2>
<p>一些大的公司都会进行静态代码分析，他们一般会通过一些定制化的工具或者平台来完成此项工作。对于中小团队来说，可以选用下面几种开源的静态代码分析工具。</p>
<ul>
<li>Checkstyle，可以用于检查代码风格，例如代码的缩进、每行的最大长度、换行等规范问题。</li>
<li>ArchUnit，可以用于检查代码的分层关系，避免不合理的代码依赖关系出现，比如循环引用等。</li>
<li>FindBugs，可以用于检查潜在的缺陷，例如打开的文件没有关闭、潜在的内存泄漏等。</li>
<li>OWASP Dependency-Check，可以用于检查引入的第三方代码包是否有公开的漏洞等。</li>
</ul>
<p>这些工具基本都有 IDE 插件，相关插件的使用比较简单，不需要过多介绍，如果希望将其集成到构建过程中，则需要使用相应的配置。海外的 Java 项目一般使用 Gradle（一种构建工具，与 Maven 类似），国内的 Java 项目则使用 Maven 较多。<br />下面以使用 Maven 为例，介绍一下如何配置这几种静态代码分析工具，并给出各个配置项的含义。本章的代码示例都是 Maven 多模块实现的，这里也推荐使用 IntelliJ IDEA 作为开发工具， 它是业界公认的优秀 Java 开发工具。<br />本节的示例代码可以在 Git 仓库 <a target="_blank" rel="noopener" href="https://github.com/java-self-testing/java-self-testing-example">https://github.com/java-self-testing/java-self-testing-example</a> 中下载。<br>
<a name="rt7uy"></a></p>
<h3 id="2-1-1-Checkstyle">2.1.1 Checkstyle</h3>
<p>Checkstyle 是一款 Java 静态代码分析工具，可帮助程序员编写符合编码规范的 Java 代码。它会自动完成检查，能让程序员避免手工做这些琐碎的事情。<br />Checkstyle 自带了 Sun 公司和谷歌公司的 Java 代码风格配置文件，我们可基于此定义适合自己团队的代码规范。可以通过 IDEA 插件、Maven、Gradle 等不同的工具和平台来运行 Checkstyle，如果有错误提示，Checkstyle 会中断构建并提供友好的报告。<br>
<a name="WeGiv"></a></p>
<h4 id="1-在-Maven-中使用-Checkstyle">1. 在 Maven 中使用 Checkstyle</h4>
<p>创建一个 Maven 模块，在 Pom 文件中添加如代码清单 2-1 所示的配置。<br />代码清单 2-1 Checkstyle 中的 Pom 配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&lt;properties&gt;</span><br><span class="line">    &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;</span><br><span class="line">&lt;/properties&gt;</span><br><span class="line"></span><br><span class="line">&lt;build&gt;</span><br><span class="line">    &lt;plugins&gt;</span><br><span class="line">        &lt;plugin&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;maven-checkstyle-plugin&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;3.1.2&lt;/version&gt;</span><br><span class="line">            &lt;dependencies&gt;</span><br><span class="line">                &lt;!--  Checkstyle plugin 使用的 Checkstyle 库，可以自定义版本  --&gt;</span><br><span class="line">                &lt;dependency&gt;</span><br><span class="line">                    &lt;groupId&gt;com.puppycrawl.tools&lt;/groupId&gt;</span><br><span class="line">                    &lt;artifactId&gt;checkstyle&lt;/artifactId&gt;</span><br><span class="line">                    &lt;version&gt;8.40&lt;/version&gt;</span><br><span class="line">                &lt;/dependency&gt;</span><br><span class="line">            &lt;/dependencies&gt;</span><br><span class="line">            &lt;executions&gt;</span><br><span class="line">                &lt;!--  加入到 maven 的构建生命周期中去  --&gt;</span><br><span class="line">                &lt;execution&gt;</span><br><span class="line">                    &lt;id&gt;checkstyle&lt;/id&gt;</span><br><span class="line">                    &lt;phase&gt;validate&lt;/phase&gt;</span><br><span class="line">                    &lt;goals&gt;</span><br><span class="line">                        &lt;goal&gt;check&lt;/goal&gt;</span><br><span class="line">                    &lt;/goals&gt;</span><br><span class="line">                    &lt;configuration&gt;</span><br><span class="line">                        &lt;failOnViolation&gt;true&lt;/failOnViolation&gt;</span><br><span class="line">                    &lt;/configuration&gt;</span><br><span class="line">                &lt;/execution&gt;</span><br><span class="line">            &lt;/executions&gt;</span><br><span class="line">        &lt;/plugin&gt;</span><br><span class="line">    &lt;/plugins&gt;</span><br><span class="line">&lt;/build&gt;</span><br></pre></td></tr></table></figure>
<p>配置完成后，可以直接使用 Maven 命令检查代码风格：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn checkstyle:check</span><br></pre></td></tr></table></figure>
<p><a name="YHWu7"></a></p>
<h4 id="2-自定义代码风格检查规则">2. 自定义代码风格检查规则</h4>
<p>Checkstyle 默认的风格可能会与我们日常开发的习惯不相符，直接使用有可能会导致在日常的开发过程中 IDE 格式化的结果和 Checkstyle 冲突、默认的参数过于苛刻等问题。虽然可以将 Checkstyle 的配置文件导入 IDE 格式化器的相关配置中，但如果有新同事加入，则又需要额外配置。所以，我们一般都会对 Checkstyle 默认的配置文件做一些修改，将其调整为适合自己团队的工作方式，尽量按照 IDE 的默认格式化风格来操作。<br />在 Maven 的 Pom 文件中通过 checkstyle.config.location 属性可以配置一个 XML 文件来定制 Checkstyle 规则，具体参考如下代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;properties&gt;</span><br><span class="line">    &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;</span><br><span class="line">    &lt;!--   自定义的配置文件，相对于 Pom 文件的路径     --&gt;</span><br><span class="line">    &lt;checkstyle.config.location&gt;checkstyle/checkstyle.xml&lt;/checkstyle.config.location&gt;</span><br><span class="line">&lt;/properties&gt;</span><br></pre></td></tr></table></figure>
<p>我们在实际项目中通常都需要定制上述规则，代码清单 2-2 基于 Google Java 代码规则对配置做了调整，并给出了具体说明。<br />代码清单 2-2 自定义 Checkstyle 规则的配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE module PUBLIC</span><br><span class="line">        &quot;-//Checkstyle//DTD Checkstyle Configuration 1.3//EN&quot;</span><br><span class="line">        &quot;https://checkstyle.org/dtds/configuration_1_3.dtd&quot;&gt;</span><br><span class="line">&lt;module name = &quot;Checker&quot;&gt;</span><br><span class="line">    &lt;property name=&quot;charset&quot; value=&quot;UTF-8&quot;/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--违规级别，用于提示给构建工具，如果是 error 级别会让构建失败--&gt;</span><br><span class="line">    &lt;property name=&quot;severity&quot; value=&quot;warning&quot;/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--扫描的文件类型--&gt;</span><br><span class="line">    &lt;property name=&quot;fileExtensions&quot; value=&quot;java, properties, xml&quot;/&gt;</span><br><span class="line">    &lt;!-- Excludes all &#x27;module-info.java&#x27; files              --&gt;</span><br><span class="line">    &lt;!-- See https://checkstyle.org/config_filefilters.html --&gt;</span><br><span class="line">    &lt;!-- 排除 &#x27;module-info.java&#x27; 模块描述文件 --&gt;</span><br><span class="line">    &lt;module name=&quot;BeforeExecutionExclusionFileFilter&quot;&gt;</span><br><span class="line">        &lt;property name=&quot;fileNamePattern&quot; value=&quot;module\-info\.java$&quot;/&gt;</span><br><span class="line">    &lt;/module&gt;</span><br><span class="line">    &lt;!-- https://checkstyle.org/config_filters.html#SuppressionFilter --&gt;</span><br><span class="line">    &lt;!--定义忽略规则文件位置--&gt;</span><br><span class="line">    &lt;module name=&quot;SuppressionFilter&quot;&gt;</span><br><span class="line">        &lt;property name=&quot;file&quot; value=&quot;$&#123;org.checkstyle.google.suppressionfilter.config&#125;&quot;</span><br><span class="line">                  default=&quot;checkstyle-suppressions.xml&quot; /&gt;</span><br><span class="line">        &lt;property name=&quot;optional&quot; value=&quot;true&quot;/&gt;</span><br><span class="line">    &lt;/module&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- Checks for whitespace                               --&gt;</span><br><span class="line">    &lt;!-- See http://checkstyle.org/config_whitespace.html --&gt;</span><br><span class="line">    &lt;!--检查文件空白制表字符--&gt;</span><br><span class="line">    &lt;module name=&quot;FileTabCharacter&quot;&gt;</span><br><span class="line">        &lt;property name=&quot;eachLine&quot; value=&quot;true&quot;/&gt;</span><br><span class="line">    &lt;/module&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--检查单行长度，原规则是 100，但是往往不够用，所以会设置长一点--&gt;</span><br><span class="line">    &lt;module name=&quot;LineLength&quot;&gt;</span><br><span class="line">        &lt;property name=&quot;fileExtensions&quot; value=&quot;java&quot;/&gt;</span><br><span class="line">        &lt;property name=&quot;max&quot; value=&quot;160&quot;/&gt;</span><br><span class="line">        &lt;property name=&quot;ignorePattern&quot; value=&quot;^package.*|^import.*|a href|href|http://|https://|ftp://&quot;/&gt;</span><br><span class="line">    &lt;/module&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--检查 Java 源代码语法树--&gt;</span><br><span class="line">    &lt;module name=&quot;TreeWalker&quot;&gt;</span><br><span class="line">        &lt;!--检查类型和文件名是否匹配，类名和文件名需要对应--&gt;</span><br><span class="line">        &lt;module name=&quot;OuterTypeFilename&quot;/&gt;</span><br><span class="line">        &lt;!--检查不合规的文本，考虑使用特殊转义序列来代替八进制值或 Unicode 值。--&gt;</span><br><span class="line">        &lt;module name=&quot;IllegalTokenText&quot;&gt;</span><br><span class="line">            &lt;property name=&quot;tokens&quot; value=&quot;STRING_LITERAL, CHAR_LITERAL&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;format&quot;</span><br><span class="line">                      value=&quot;\\u00(09|0(a|A)|0(c|C)|0(d|D)|22|27|5(C|c))|\\(0(10|11|12|14|15|42|47)|134)&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;message&quot;</span><br><span class="line">                      value=&quot;Consider using special escape sequence instead of octal value or Unicode escaped value.&quot;/&gt;</span><br><span class="line">        &lt;/module&gt;</span><br><span class="line">        &lt;!--避免使用 Unicode 转义--&gt;</span><br><span class="line">        &lt;module name=&quot;AvoidEscapedUnicodeCharacters&quot;&gt;</span><br><span class="line">            &lt;property name=&quot;allowEscapesForControlCharacters&quot; value=&quot;true&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;allowByTailComment&quot; value=&quot;true&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;allowNonPrintableEscapes&quot; value=&quot;true&quot;/&gt;</span><br><span class="line">        &lt;/module&gt;</span><br><span class="line">        &lt;!--避免在 import 语句中使用 * --&gt;</span><br><span class="line">        &lt;module name=&quot;AvoidStarImport&quot;/&gt;</span><br><span class="line">        &lt;!--每个文件中只允许有一个顶级类--&gt;</span><br><span class="line">        &lt;module name=&quot;OneTopLevelClass&quot;/&gt;</span><br><span class="line">        &lt;!--该类语句不允许换行--&gt;</span><br><span class="line">        &lt;module name=&quot;NoLineWrap&quot;&gt;</span><br><span class="line">            &lt;property name=&quot;tokens&quot; value=&quot;PACKAGE_DEF, IMPORT, STATIC_IMPORT&quot;/&gt;</span><br><span class="line">        &lt;/module&gt;</span><br><span class="line">        &lt;!--检查空块--&gt;</span><br><span class="line">        &lt;module name=&quot;EmptyBlock&quot;&gt;</span><br><span class="line">            &lt;property name=&quot;option&quot; value=&quot;TEXT&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;tokens&quot;</span><br><span class="line">                      value=&quot;LITERAL_TRY, LITERAL_FINALLY, LITERAL_IF, LITERAL_ELSE, LITERAL_SWITCH&quot;/&gt;</span><br><span class="line">        &lt;/module&gt;</span><br><span class="line">        &lt;!--检查代码块周围的大括号，这些大括号不允许省略--&gt;</span><br><span class="line">        &lt;module name=&quot;NeedBraces&quot;&gt;</span><br><span class="line">            &lt;property name=&quot;tokens&quot;</span><br><span class="line">                      value=&quot;LITERAL_DO, LITERAL_ELSE, LITERAL_FOR, LITERAL_IF, LITERAL_WHILE&quot;/&gt;</span><br><span class="line">        &lt;/module&gt;</span><br><span class="line">        &lt;!--检查代码块的左花括号的位置--&gt;</span><br><span class="line">        &lt;module name=&quot;LeftCurly&quot;&gt;</span><br><span class="line">            &lt;property name=&quot;tokens&quot;</span><br><span class="line">                      value=&quot;ANNOTATION_DEF, CLASS_DEF, CTOR_DEF, ENUM_CONSTANT_DEF, ENUM_DEF,</span><br><span class="line">                    INTERFACE_DEF, LAMBDA, LITERAL_CASE, LITERAL_CATCH, LITERAL_DEFAULT,</span><br><span class="line">                    LITERAL_DO, LITERAL_ELSE, LITERAL_FINALLY, LITERAL_FOR, LITERAL_IF,</span><br><span class="line">                    LITERAL_SWITCH, LITERAL_SYNCHRONIZED, LITERAL_TRY, LITERAL_WHILE, METHOD_DEF,</span><br><span class="line">                    OBJBLOCK, STATIC_INIT, RECORD_DEF, COMPACT_CTOR_DEF&quot;/&gt;</span><br><span class="line">        &lt;/module&gt;</span><br><span class="line">        &lt;!--检查代码块的右花括号的位置--&gt;</span><br><span class="line">        &lt;module name=&quot;RightCurly&quot;&gt;</span><br><span class="line">            &lt;property name=&quot;id&quot; value=&quot;RightCurlySame&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;tokens&quot;</span><br><span class="line">                      value=&quot;LITERAL_TRY, LITERAL_CATCH, LITERAL_FINALLY, LITERAL_IF, LITERAL_ELSE,</span><br><span class="line">                    LITERAL_DO&quot;/&gt;</span><br><span class="line">        &lt;/module&gt;</span><br><span class="line">        &lt;!--检查代码块的右花括号的位置，必须单独一行--&gt;</span><br><span class="line">        &lt;module name=&quot;RightCurly&quot;&gt;</span><br><span class="line">            &lt;property name=&quot;id&quot; value=&quot;RightCurlyAlone&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;option&quot; value=&quot;alone&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;tokens&quot;</span><br><span class="line">                      value=&quot;CLASS_DEF, METHOD_DEF, CTOR_DEF, LITERAL_FOR, LITERAL_WHILE, STATIC_INIT,</span><br><span class="line">                    INSTANCE_INIT, ANNOTATION_DEF, ENUM_DEF, INTERFACE_DEF, RECORD_DEF,</span><br><span class="line">                    COMPACT_CTOR_DEF&quot;/&gt;</span><br><span class="line">        &lt;/module&gt;</span><br><span class="line">        &lt;module name=&quot;SuppressionXpathSingleFilter&quot;&gt;</span><br><span class="line">            &lt;!-- suppresion is required till https://github.com/checkstyle/checkstyle/issues/7541 --&gt;</span><br><span class="line">            &lt;property name=&quot;id&quot; value=&quot;RightCurlyAlone&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;query&quot; value=&quot;//RCURLY[parent::SLIST[count(./*)=1]</span><br><span class="line">                                     or preceding-sibling::*[last()][self::LCURLY]]&quot;/&gt;</span><br><span class="line">        &lt;/module&gt;</span><br><span class="line">        &lt;!--检查关键字后面的空格--&gt;</span><br><span class="line">        &lt;module name=&quot;WhitespaceAfter&quot;&gt;</span><br><span class="line">            &lt;property name=&quot;tokens&quot;</span><br><span class="line">                      value=&quot;COMMA, SEMI, TYPECAST, LITERAL_IF, LITERAL_ELSE,</span><br><span class="line">                    LITERAL_WHILE, LITERAL_DO, LITERAL_FOR, DO_WHILE&quot;/&gt;</span><br><span class="line">        &lt;/module&gt;</span><br><span class="line">        &lt;!--检查关键字是否被空格包围，一般是语句，比如空构造函数--&gt;</span><br><span class="line">        &lt;module name=&quot;WhitespaceAround&quot;&gt;</span><br><span class="line">            &lt;property name=&quot;allowEmptyConstructors&quot; value=&quot;true&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;allowEmptyLambdas&quot; value=&quot;true&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;allowEmptyMethods&quot; value=&quot;true&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;allowEmptyTypes&quot; value=&quot;true&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;allowEmptyLoops&quot; value=&quot;true&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;ignoreEnhancedForColon&quot; value=&quot;false&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;tokens&quot;</span><br><span class="line">                      value=&quot;ASSIGN, BAND, BAND_ASSIGN, BOR, BOR_ASSIGN, BSR, BSR_ASSIGN, BXOR,</span><br><span class="line">                    BXOR_ASSIGN, COLON, DIV, DIV_ASSIGN, DO_WHILE, EQUAL, GE, GT, LAMBDA, LAND,</span><br><span class="line">                    LCURLY, LE, LITERAL_CATCH, LITERAL_DO, LITERAL_ELSE, LITERAL_FINALLY,</span><br><span class="line">                    LITERAL_FOR, LITERAL_IF, LITERAL_RETURN, LITERAL_SWITCH, LITERAL_SYNCHRONIZED,</span><br><span class="line">                    LITERAL_TRY, LITERAL_WHILE, LOR, LT, MINUS, MINUS_ASSIGN, MOD, MOD_ASSIGN,</span><br><span class="line">                    NOT_EQUAL, PLUS, PLUS_ASSIGN, QUESTION, RCURLY, SL, SLIST, SL_ASSIGN, SR,</span><br><span class="line">                    SR_ASSIGN, STAR, STAR_ASSIGN, LITERAL_ASSERT, TYPE_EXTENSION_AND&quot;/&gt;</span><br><span class="line">            &lt;message key=&quot;ws.notFollowed&quot;</span><br><span class="line">                     value=&quot;WhitespaceAround: &#x27;&#x27;&#123;0&#125;&#x27;&#x27; is not followed by whitespace. Empty blocks may only be represented as &#x27;&#123;&#125;&#x27; when not part of a multi-block statement (4.1.3)&quot;/&gt;</span><br><span class="line">            &lt;message key=&quot;ws.notPreceded&quot;</span><br><span class="line">                     value=&quot;WhitespaceAround: &#x27;&#x27;&#123;0&#125;&#x27;&#x27; is not preceded with whitespace.&quot;/&gt;</span><br><span class="line">        &lt;/module&gt;</span><br><span class="line">        &lt;!--检查每行只有一个语句--&gt;</span><br><span class="line">        &lt;module name=&quot;OneStatementPerLine&quot;/&gt;</span><br><span class="line">        &lt;!--避免变量连续定义和换行定义，每个变量都需要在自己的行中单独定义--&gt;</span><br><span class="line">        &lt;module name=&quot;MultipleVariableDeclarations&quot;/&gt;</span><br><span class="line">        &lt;!--检查数组类型定义的风格--&gt;</span><br><span class="line">        &lt;module name=&quot;ArrayTypeStyle&quot;/&gt;</span><br><span class="line">        &lt;!--检查 switch 必须具有 default 子句--&gt;</span><br><span class="line">        &lt;module name=&quot;MissingSwitchDefault&quot;/&gt;</span><br><span class="line">        &lt;!--检查 switch 语句，case 子句如果有代码，必须使用 break 语句或抛出异常--&gt;</span><br><span class="line">        &lt;module name=&quot;FallThrough&quot;/&gt;</span><br><span class="line">        &lt;!--检查常量是否用大写定义--&gt;</span><br><span class="line">        &lt;module name=&quot;UpperEll&quot;/&gt;</span><br><span class="line">        &lt;!--检查修饰符是否符合顺序--&gt;</span><br><span class="line">        &lt;module name=&quot;ModifierOrder&quot;/&gt;</span><br><span class="line">        &lt;!--检查空行，在必要的地方需要空行--&gt;</span><br><span class="line">        &lt;module name=&quot;EmptyLineSeparator&quot;&gt;</span><br><span class="line">            &lt;property name=&quot;tokens&quot;</span><br><span class="line">                      value=&quot;PACKAGE_DEF, IMPORT, STATIC_IMPORT, CLASS_DEF, INTERFACE_DEF, ENUM_DEF,</span><br><span class="line">                    STATIC_INIT, INSTANCE_INIT, METHOD_DEF, CTOR_DEF, VARIABLE_DEF, RECORD_DEF,</span><br><span class="line">                    COMPACT_CTOR_DEF&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;allowNoEmptyLineBetweenFields&quot; value=&quot;true&quot;/&gt;</span><br><span class="line">        &lt;/module&gt;</span><br><span class="line">        &lt;!--定义一些不允许换行的关键字，比如点、逗号等--&gt;</span><br><span class="line">        &lt;module name=&quot;SeparatorWrap&quot;&gt;</span><br><span class="line">            &lt;property name=&quot;id&quot; value=&quot;SeparatorWrapDot&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;tokens&quot; value=&quot;DOT&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;option&quot; value=&quot;nl&quot;/&gt;</span><br><span class="line">        &lt;/module&gt;</span><br><span class="line">        &lt;module name=&quot;SeparatorWrap&quot;&gt;</span><br><span class="line">            &lt;property name=&quot;id&quot; value=&quot;SeparatorWrapComma&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;tokens&quot; value=&quot;COMMA&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;option&quot; value=&quot;EOL&quot;/&gt;</span><br><span class="line">        &lt;/module&gt;</span><br><span class="line">        &lt;module name=&quot;SeparatorWrap&quot;&gt;</span><br><span class="line">            &lt;!-- ELLIPSIS is EOL until https://github.com/google/styleguide/issues/259 --&gt;</span><br><span class="line">            &lt;property name=&quot;id&quot; value=&quot;SeparatorWrapEllipsis&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;tokens&quot; value=&quot;ELLIPSIS&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;option&quot; value=&quot;EOL&quot;/&gt;</span><br><span class="line">        &lt;/module&gt;</span><br><span class="line">        &lt;module name=&quot;SeparatorWrap&quot;&gt;</span><br><span class="line">            &lt;!-- ARRAY_DECLARATOR is EOL until https://github.com/google/styleguide/issues/258 --&gt;</span><br><span class="line">            &lt;property name=&quot;id&quot; value=&quot;SeparatorWrapArrayDeclarator&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;tokens&quot; value=&quot;ARRAY_DECLARATOR&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;option&quot; value=&quot;EOL&quot;/&gt;</span><br><span class="line">        &lt;/module&gt;</span><br><span class="line">        &lt;module name=&quot;SeparatorWrap&quot;&gt;</span><br><span class="line">            &lt;property name=&quot;id&quot; value=&quot;SeparatorWrapMethodRef&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;tokens&quot; value=&quot;METHOD_REF&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;option&quot; value=&quot;nl&quot;/&gt;</span><br><span class="line">        &lt;/module&gt;</span><br><span class="line">        &lt;!--检查包名称是否符合规则--&gt;</span><br><span class="line">        &lt;module name=&quot;PackageName&quot;&gt;</span><br><span class="line">            &lt;property name=&quot;format&quot; value=&quot;^[a-z]+(\.[a-z][a-z0-9]*)*$&quot;/&gt;</span><br><span class="line">            &lt;message key=&quot;name.invalidPattern&quot;</span><br><span class="line">                     value=&quot;Package name &#x27;&#x27;&#123;0&#125;&#x27;&#x27; must match pattern &#x27;&#x27;&#123;1&#125;&#x27;&#x27;.&quot;/&gt;</span><br><span class="line">        &lt;/module&gt;</span><br><span class="line">        &lt;!--检查类型名称是否符合规则--&gt;</span><br><span class="line">        &lt;module name=&quot;TypeName&quot;&gt;</span><br><span class="line">            &lt;property name=&quot;tokens&quot; value=&quot;CLASS_DEF, INTERFACE_DEF, ENUM_DEF,</span><br><span class="line">                    ANNOTATION_DEF, RECORD_DEF&quot;/&gt;</span><br><span class="line">            &lt;message key=&quot;name.invalidPattern&quot;</span><br><span class="line">                     value=&quot;Type name &#x27;&#x27;&#123;0&#125;&#x27;&#x27; must match pattern &#x27;&#x27;&#123;1&#125;&#x27;&#x27;.&quot;/&gt;</span><br><span class="line">        &lt;/module&gt;</span><br><span class="line">        &lt;!--检查实例成员变量是否符合规则--&gt;</span><br><span class="line">        &lt;module name=&quot;MemberName&quot;&gt;</span><br><span class="line">            &lt;property name=&quot;format&quot; value=&quot;^[a-z][a-z0-9][a-zA-Z0-9]*$&quot;/&gt;</span><br><span class="line">            &lt;message key=&quot;name.invalidPattern&quot;</span><br><span class="line">                     value=&quot;Member name &#x27;&#x27;&#123;0&#125;&#x27;&#x27; must match pattern &#x27;&#x27;&#123;1&#125;&#x27;&#x27;.&quot;/&gt;</span><br><span class="line">        &lt;/module&gt;</span><br><span class="line">        &lt;!--检查参数名称是否符合规则--&gt;</span><br><span class="line">        &lt;module name=&quot;ParameterName&quot;&gt;</span><br><span class="line">            &lt;property name=&quot;format&quot; value=&quot;^[a-z]([a-z0-9][a-zA-Z0-9]*)?$&quot;/&gt;</span><br><span class="line">            &lt;message key=&quot;name.invalidPattern&quot;</span><br><span class="line">                     value=&quot;Parameter name &#x27;&#x27;&#123;0&#125;&#x27;&#x27; must match pattern &#x27;&#x27;&#123;1&#125;&#x27;&#x27;.&quot;/&gt;</span><br><span class="line">        &lt;/module&gt;</span><br><span class="line">        &lt;!--检查 Lambda 名称是否符合规则--&gt;</span><br><span class="line">        &lt;module name=&quot;LambdaParameterName&quot;&gt;</span><br><span class="line">            &lt;property name=&quot;format&quot; value=&quot;^[a-z]([a-z0-9][a-zA-Z0-9]*)?$&quot;/&gt;</span><br><span class="line">            &lt;message key=&quot;name.invalidPattern&quot;</span><br><span class="line">                     value=&quot;Lambda parameter name &#x27;&#x27;&#123;0&#125;&#x27;&#x27; must match pattern &#x27;&#x27;&#123;1&#125;&#x27;&#x27;.&quot;/&gt;</span><br><span class="line">        &lt;/module&gt;</span><br><span class="line">        &lt;!--检查 catch 参数名称是否符合规则--&gt;</span><br><span class="line">        &lt;module name=&quot;CatchParameterName&quot;&gt;</span><br><span class="line">            &lt;property name=&quot;format&quot; value=&quot;^[a-z]([a-z0-9][a-zA-Z0-9]*)?$&quot;/&gt;</span><br><span class="line">            &lt;message key=&quot;name.invalidPattern&quot;</span><br><span class="line">                     value=&quot;Catch parameter name &#x27;&#x27;&#123;0&#125;&#x27;&#x27; must match pattern &#x27;&#x27;&#123;1&#125;&#x27;&#x27;.&quot;/&gt;</span><br><span class="line">        &lt;/module&gt;</span><br><span class="line">        &lt;!--检查本地变量名称是否符合规则--&gt;</span><br><span class="line">        &lt;module name=&quot;LocalVariableName&quot;&gt;</span><br><span class="line">            &lt;property name=&quot;format&quot; value=&quot;^[a-z]([a-z0-9][a-zA-Z0-9]*)?$&quot;/&gt;</span><br><span class="line">            &lt;message key=&quot;name.invalidPattern&quot;</span><br><span class="line">                     value=&quot;Local variable name &#x27;&#x27;&#123;0&#125;&#x27;&#x27; must match pattern &#x27;&#x27;&#123;1&#125;&#x27;&#x27;.&quot;/&gt;</span><br><span class="line">        &lt;/module&gt;</span><br><span class="line">        &lt;module name=&quot;PatternVariableName&quot;&gt;</span><br><span class="line">            &lt;property name=&quot;format&quot; value=&quot;^[a-z]([a-z0-9][a-zA-Z0-9]*)?$&quot;/&gt;</span><br><span class="line">            &lt;message key=&quot;name.invalidPattern&quot;</span><br><span class="line">                     value=&quot;Pattern variable name &#x27;&#x27;&#123;0&#125;&#x27;&#x27; must match pattern &#x27;&#x27;&#123;1&#125;&#x27;&#x27;.&quot;/&gt;</span><br><span class="line">        &lt;/module&gt;</span><br><span class="line">        &lt;!--检查类类型参数(泛型)名称是否符合规则--&gt;</span><br><span class="line">        &lt;module name=&quot;ClassTypeParameterName&quot;&gt;</span><br><span class="line">            &lt;property name=&quot;format&quot; value=&quot;(^[A-Z][0-9]?)$|([A-Z][a-zA-Z0-9]*[T]$)&quot;/&gt;</span><br><span class="line">            &lt;message key=&quot;name.invalidPattern&quot;</span><br><span class="line">                     value=&quot;Class type name &#x27;&#x27;&#123;0&#125;&#x27;&#x27; must match pattern &#x27;&#x27;&#123;1&#125;&#x27;&#x27;.&quot;/&gt;</span><br><span class="line">        &lt;/module&gt;</span><br><span class="line">        &lt;!--检查字段（record 为 Java 新特性）名称是否符合规则--&gt;</span><br><span class="line">        &lt;module name=&quot;RecordComponentName&quot;&gt;</span><br><span class="line">            &lt;property name=&quot;format&quot; value=&quot;^[a-z]([a-z0-9][a-zA-Z0-9]*)?$&quot;/&gt;</span><br><span class="line">            &lt;message key=&quot;name.invalidPattern&quot;</span><br><span class="line">                     value=&quot;Record component name &#x27;&#x27;&#123;0&#125;&#x27;&#x27; must match pattern &#x27;&#x27;&#123;1&#125;&#x27;&#x27;.&quot;/&gt;</span><br><span class="line">        &lt;/module&gt;</span><br><span class="line">        &lt;!--检查字段（record 为 Java 新特性）类型名称是否符合规则--&gt;</span><br><span class="line">        &lt;module name=&quot;RecordTypeParameterName&quot;&gt;</span><br><span class="line">            &lt;property name=&quot;format&quot; value=&quot;(^[A-Z][0-9]?)$|([A-Z][a-zA-Z0-9]*[T]$)&quot;/&gt;</span><br><span class="line">            &lt;message key=&quot;name.invalidPattern&quot;</span><br><span class="line">                     value=&quot;Record type name &#x27;&#x27;&#123;0&#125;&#x27;&#x27; must match pattern &#x27;&#x27;&#123;1&#125;&#x27;&#x27;.&quot;/&gt;</span><br><span class="line">        &lt;/module&gt;</span><br><span class="line">        &lt;!--检查方法类型参数名称是否符合规则--&gt;</span><br><span class="line">        &lt;module name=&quot;MethodTypeParameterName&quot;&gt;</span><br><span class="line">            &lt;property name=&quot;format&quot; value=&quot;(^[A-Z][0-9]?)$|([A-Z][a-zA-Z0-9]*[T]$)&quot;/&gt;</span><br><span class="line">            &lt;message key=&quot;name.invalidPattern&quot;</span><br><span class="line">                     value=&quot;Method type name &#x27;&#x27;&#123;0&#125;&#x27;&#x27; must match pattern &#x27;&#x27;&#123;1&#125;&#x27;&#x27;.&quot;/&gt;</span><br><span class="line">        &lt;/module&gt;</span><br><span class="line">        &lt;!--检查接口类型参数名称是否符合规则--&gt;</span><br><span class="line">        &lt;module name=&quot;InterfaceTypeParameterName&quot;&gt;</span><br><span class="line">            &lt;property name=&quot;format&quot; value=&quot;(^[A-Z][0-9]?)$|([A-Z][a-zA-Z0-9]*[T]$)&quot;/&gt;</span><br><span class="line">            &lt;message key=&quot;name.invalidPattern&quot;</span><br><span class="line">                     value=&quot;Interface type name &#x27;&#x27;&#123;0&#125;&#x27;&#x27; must match pattern &#x27;&#x27;&#123;1&#125;&#x27;&#x27;.&quot;/&gt;</span><br><span class="line">        &lt;/module&gt;</span><br><span class="line">        &lt;!--不允许定义无参的 finalize 方法--&gt;</span><br><span class="line">        &lt;module name=&quot;NoFinalizer&quot;/&gt;</span><br><span class="line">        &lt;!--检查尖括号的空白字符规则--&gt;</span><br><span class="line">        &lt;module name=&quot;GenericWhitespace&quot;&gt;</span><br><span class="line">            &lt;message key=&quot;ws.followed&quot;</span><br><span class="line">                     value=&quot;GenericWhitespace &#x27;&#x27;&#123;0&#125;&#x27;&#x27; is followed by whitespace.&quot;/&gt;</span><br><span class="line">            &lt;message key=&quot;ws.preceded&quot;</span><br><span class="line">                     value=&quot;GenericWhitespace &#x27;&#x27;&#123;0&#125;&#x27;&#x27; is preceded with whitespace.&quot;/&gt;</span><br><span class="line">            &lt;message key=&quot;ws.illegalFollow&quot;</span><br><span class="line">                     value=&quot;GenericWhitespace &#x27;&#x27;&#123;0&#125;&#x27;&#x27; should followed by whitespace.&quot;/&gt;</span><br><span class="line">            &lt;message key=&quot;ws.notPreceded&quot;</span><br><span class="line">                     value=&quot;GenericWhitespace &#x27;&#x27;&#123;0&#125;&#x27;&#x27; is not preceded with whitespace.&quot;/&gt;</span><br><span class="line">        &lt;/module&gt;</span><br><span class="line">        &lt;!--检查缩进规则--&gt;</span><br><span class="line">        &lt;module name=&quot;Indentation&quot;&gt;</span><br><span class="line">            &lt;property name=&quot;basicOffset&quot; value=&quot;2&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;braceAdjustment&quot; value=&quot;2&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;caseIndent&quot; value=&quot;2&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;throwsIndent&quot; value=&quot;4&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;lineWrappingIndentation&quot; value=&quot;4&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;arrayInitIndent&quot; value=&quot;2&quot;/&gt;</span><br><span class="line">        &lt;/module&gt;</span><br><span class="line">        &lt;!--检查是否以大写字母作为缩写的长度--&gt;</span><br><span class="line">        &lt;module name=&quot;AbbreviationAsWordInName&quot;&gt;</span><br><span class="line">            &lt;property name=&quot;ignoreFinal&quot; value=&quot;false&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;allowedAbbreviationLength&quot; value=&quot;0&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;tokens&quot;</span><br><span class="line">                      value=&quot;CLASS_DEF, INTERFACE_DEF, ENUM_DEF, ANNOTATION_DEF, ANNOTATION_FIELD_DEF,</span><br><span class="line">                    PARAMETER_DEF, VARIABLE_DEF, METHOD_DEF, PATTERN_VARIABLE_DEF, RECORD_DEF,</span><br><span class="line">                    RECORD_COMPONENT_DEF&quot;/&gt;</span><br><span class="line">        &lt;/module&gt;</span><br><span class="line">        &lt;!--检查覆写方法在类中的顺序--&gt;</span><br><span class="line">        &lt;module name=&quot;OverloadMethodsDeclarationOrder&quot;/&gt;</span><br><span class="line">        &lt;!--检查变量声明与第一被使用之间的距离--&gt;</span><br><span class="line">        &lt;module name=&quot;VariableDeclarationUsageDistance&quot;/&gt;</span><br><span class="line">        &lt;!--检查 import 语句的顺序--&gt;</span><br><span class="line">        &lt;module name=&quot;CustomImportOrder&quot;&gt;</span><br><span class="line">            &lt;property name=&quot;sortImportsInGroupAlphabetically&quot; value=&quot;true&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;separateLineBetweenGroups&quot; value=&quot;true&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;customImportOrderRules&quot; value=&quot;STATIC###THIRD_PARTY_PACKAGE&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;tokens&quot; value=&quot;IMPORT, STATIC_IMPORT, PACKAGE_DEF&quot;/&gt;</span><br><span class="line">        &lt;/module&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!--检查方法名称和左括号之间的空格--&gt;</span><br><span class="line">        &lt;module name=&quot;MethodParamPad&quot;&gt;</span><br><span class="line">            &lt;property name=&quot;tokens&quot;</span><br><span class="line">                      value=&quot;CTOR_DEF, LITERAL_NEW, METHOD_CALL, METHOD_DEF,</span><br><span class="line">                    SUPER_CTOR_CALL, ENUM_CONSTANT_DEF, RECORD_DEF&quot;/&gt;</span><br><span class="line">        &lt;/module&gt;</span><br><span class="line">        &lt;!--检查关键字前面的空格--&gt;</span><br><span class="line">        &lt;module name=&quot;NoWhitespaceBefore&quot;&gt;</span><br><span class="line">            &lt;property name=&quot;tokens&quot;</span><br><span class="line">                      value=&quot;COMMA, SEMI, POST_INC, POST_DEC, DOT,</span><br><span class="line">                    LABELED_STAT, METHOD_REF&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;allowLineBreaks&quot; value=&quot;true&quot;/&gt;</span><br><span class="line">        &lt;/module&gt;</span><br><span class="line">        &lt;!--检查括号前后是否需要空格--&gt;</span><br><span class="line">        &lt;module name=&quot;ParenPad&quot;&gt;</span><br><span class="line">            &lt;property name=&quot;tokens&quot;</span><br><span class="line">                      value=&quot;ANNOTATION, ANNOTATION_FIELD_DEF, CTOR_CALL, CTOR_DEF, DOT, ENUM_CONSTANT_DEF,</span><br><span class="line">                    EXPR, LITERAL_CATCH, LITERAL_DO, LITERAL_FOR, LITERAL_IF, LITERAL_NEW,</span><br><span class="line">                    LITERAL_SWITCH, LITERAL_SYNCHRONIZED, LITERAL_WHILE, METHOD_CALL,</span><br><span class="line">                    METHOD_DEF, QUESTION, RESOURCE_SPECIFICATION, SUPER_CTOR_CALL, LAMBDA,</span><br><span class="line">                    RECORD_DEF&quot;/&gt;</span><br><span class="line">        &lt;/module&gt;</span><br><span class="line">        &lt;!--检查运算符换行的规则--&gt;</span><br><span class="line">        &lt;module name=&quot;OperatorWrap&quot;&gt;</span><br><span class="line">            &lt;!-- 操作符需要在新行--&gt;</span><br><span class="line">            &lt;property name=&quot;option&quot; value=&quot;NL&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;tokens&quot;</span><br><span class="line">                      value=&quot;BAND, BOR, BSR, BXOR, DIV, EQUAL, GE, GT, LAND, LE, LITERAL_INSTANCEOF, LOR,</span><br><span class="line">                    LT, MINUS, MOD, NOT_EQUAL, PLUS, QUESTION, SL, SR, STAR, METHOD_REF &quot;/&gt;</span><br><span class="line">        &lt;/module&gt;</span><br><span class="line">        &lt;!--检查注解位置规则，比如类的定义中注释需要单独一行--&gt;</span><br><span class="line">        &lt;module name=&quot;AnnotationLocation&quot;&gt;</span><br><span class="line">            &lt;property name=&quot;id&quot; value=&quot;AnnotationLocationMostCases&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;tokens&quot;</span><br><span class="line">                      value=&quot;CLASS_DEF, INTERFACE_DEF, ENUM_DEF, METHOD_DEF, CTOR_DEF,</span><br><span class="line">                      RECORD_DEF, COMPACT_CTOR_DEF&quot;/&gt;</span><br><span class="line">        &lt;/module&gt;</span><br><span class="line">        &lt;!--检查注解位置规则，变量定义注释可以一行定义多个--&gt;</span><br><span class="line">        &lt;module name=&quot;AnnotationLocation&quot;&gt;</span><br><span class="line">            &lt;property name=&quot;id&quot; value=&quot;AnnotationLocationVariables&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;tokens&quot; value=&quot;VARIABLE_DEF&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;allowSamelineMultipleAnnotations&quot; value=&quot;true&quot;/&gt;</span><br><span class="line">        &lt;/module&gt;</span><br><span class="line">        &lt;!--这部分是注释相关的配置--&gt;</span><br><span class="line">        &lt;!--块注释中 @ 子句后面不能为空--&gt;</span><br><span class="line">        &lt;module name=&quot;NonEmptyAtclauseDescription&quot;/&gt;</span><br><span class="line">        &lt;!--检查注释位置，块注释必须在所有注解前面--&gt;</span><br><span class="line">        &lt;module name=&quot;InvalidJavadocPosition&quot;/&gt;</span><br><span class="line">        &lt;!--检查注释必须统一缩进--&gt;</span><br><span class="line">        &lt;module name=&quot;JavadocTagContinuationIndentation&quot;/&gt;</span><br><span class="line">        &lt;!--检查描述性注释，方法的块注释第一行必须总结这个方法，一般我们不要求，会关闭此行--&gt;</span><br><span class="line">&lt;!--        &lt;module name=&quot;SummaryJavadoc&quot;&gt;--&gt;</span><br><span class="line">&lt;!--            &lt;property name=&quot;forbiddenSummaryFragments&quot;--&gt;</span><br><span class="line">&lt;!--                      value=&quot;^@return the *|^This method returns |^A [&#123;]@code [a-zA-Z0-9]+[&#125;]( is a )&quot;/&gt;--&gt;</span><br><span class="line">&lt;!--        &lt;/module&gt;--&gt;</span><br><span class="line">        &lt;!--检查注释段落，段落之间需要换行，另外使用了 &lt;p&gt; 标签不能有空格--&gt;</span><br><span class="line">        &lt;module name=&quot;JavadocParagraph&quot;/&gt;</span><br><span class="line">        &lt;!--检查注释段落，块标签之前需要一个空格，比如 @return --&gt;</span><br><span class="line">        &lt;module name=&quot;RequireEmptyLineBeforeBlockTagGroup&quot;/&gt;</span><br><span class="line">        &lt;!--检查注释段落块标签顺序 --&gt;</span><br><span class="line">        &lt;module name=&quot;AtclauseOrder&quot;&gt;</span><br><span class="line">            &lt;property name=&quot;tagOrder&quot; value=&quot;@param, @return, @throws, @deprecated&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;target&quot;</span><br><span class="line">                      value=&quot;CLASS_DEF, INTERFACE_DEF, ENUM_DEF, METHOD_DEF, CTOR_DEF, VARIABLE_DEF&quot;/&gt;</span><br><span class="line">        &lt;/module&gt;</span><br><span class="line">        &lt;!--检查 public 方法的注释规则 --&gt;</span><br><span class="line">        &lt;module name=&quot;JavadocMethod&quot;&gt;</span><br><span class="line">            &lt;property name=&quot;scope&quot; value=&quot;public&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;allowMissingParamTags&quot; value=&quot;true&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;allowMissingReturnTag&quot; value=&quot;true&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;allowedAnnotations&quot; value=&quot;Override, Test&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;tokens&quot; value=&quot;METHOD_DEF, CTOR_DEF, ANNOTATION_FIELD_DEF, COMPACT_CTOR_DEF&quot;/&gt;</span><br><span class="line">        &lt;/module&gt;</span><br><span class="line">        &lt;!--对于一些方法可以忽略方法的注释规则。例如，带有Override 注解的方法--&gt;</span><br><span class="line">        &lt;module name=&quot;MissingJavadocMethod&quot;&gt;</span><br><span class="line">            &lt;property name=&quot;scope&quot; value=&quot;public&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;minLineCount&quot; value=&quot;2&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;allowedAnnotations&quot; value=&quot;Override, Test&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;tokens&quot; value=&quot;METHOD_DEF, CTOR_DEF, ANNOTATION_FIELD_DEF,</span><br><span class="line">                                   COMPACT_CTOR_DEF&quot;/&gt;</span><br><span class="line">        &lt;/module&gt;</span><br><span class="line">        &lt;!--检查方法必须提供注释的规则 --&gt;</span><br><span class="line">        &lt;module name=&quot;MissingJavadocType&quot;&gt;</span><br><span class="line">            &lt;property name=&quot;scope&quot; value=&quot;protected&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;tokens&quot;</span><br><span class="line">                      value=&quot;CLASS_DEF, INTERFACE_DEF, ENUM_DEF,</span><br><span class="line">                      RECORD_DEF, ANNOTATION_DEF&quot;/&gt;</span><br><span class="line">            &lt;property name=&quot;excludeScope&quot; value=&quot;nothing&quot;/&gt;</span><br><span class="line">        &lt;/module&gt;</span><br><span class="line">        &lt;!--检查方法名是否符合规则 --&gt;</span><br><span class="line">        &lt;module name=&quot;MethodName&quot;&gt;</span><br><span class="line">            &lt;property name=&quot;format&quot; value=&quot;^[a-z][a-z0-9][a-zA-Z0-9_]*$&quot;/&gt;</span><br><span class="line">            &lt;message key=&quot;name.invalidPattern&quot;</span><br><span class="line">                     value=&quot;Method name &#x27;&#x27;&#123;0&#125;&#x27;&#x27; must match pattern &#x27;&#x27;&#123;1&#125;&#x27;&#x27;.&quot;/&gt;</span><br><span class="line">        &lt;/module&gt;</span><br><span class="line">        &lt;!--单行注释规则,单行注释不允许使用块中的标签 --&gt;</span><br><span class="line">        &lt;module name=&quot;SingleLineJavadoc&quot;/&gt;</span><br><span class="line">        &lt;!--检查空的 catch 块--&gt;</span><br><span class="line">        &lt;module name=&quot;EmptyCatchBlock&quot;&gt;</span><br><span class="line">            &lt;property name=&quot;exceptionVariableName&quot; value=&quot;expected&quot;/&gt;</span><br><span class="line">        &lt;/module&gt;</span><br><span class="line">        &lt;!--检查注释代码之间的缩进--&gt;</span><br><span class="line">        &lt;module name=&quot;CommentsIndentation&quot;&gt;</span><br><span class="line">            &lt;property name=&quot;tokens&quot; value=&quot;SINGLE_LINE_COMMENT, BLOCK_COMMENT_BEGIN&quot;/&gt;</span><br><span class="line">        &lt;/module&gt;</span><br><span class="line">        &lt;!-- https://checkstyle.org/config_filters.html#SuppressionXpathFilter --&gt;</span><br><span class="line">        &lt;module name=&quot;SuppressionXpathFilter&quot;&gt;</span><br><span class="line">            &lt;property name=&quot;file&quot; value=&quot;$&#123;org.checkstyle.google.suppressionxpathfilter.config&#125;&quot;</span><br><span class="line">                      default=&quot;checkstyle-xpath-suppressions.xml&quot; /&gt;</span><br><span class="line">            &lt;property name=&quot;optional&quot; value=&quot;true&quot;/&gt;</span><br><span class="line">        &lt;/module&gt;</span><br><span class="line">    &lt;/module&gt;</span><br><span class="line">&lt;/module&gt;</span><br></pre></td></tr></table></figure>
<p><a name="lmZh2"></a></p>
<h3 id="2-1-2-FindBugs">2.1.2 FindBugs</h3>
<p>FindBugs 是一个开源工具，可用于对 Java 代码执行静态代码分析，其由马里兰大学 Bill Pugh 领导的团队研发，实现原理是对字节码进行扫描并进行模式识别。和 Checkstyle 不一样的是，FindBugs 会通过对代码的模式进行分析来发现潜在的 Bug 和安全问题，而 Checkstyle 只能作为检查代码风格的工具。虽然 FindBugs 和 Checkstyle 的部分功能重叠，但两者的定位明显不同。<br />FindBugs 中包含下面几种问题类型。</p>
<ul>
<li>Correctness：由开发人员疏忽造成的正确性问题，比如无限递归调用。</li>
<li>Bad practice：代码中的一些坏习惯，比如使用 == 对 String 做判定。</li>
<li>Dodgy code：糟糕的代码，能工作但不是好的实现，比如冗余的流程控制。</li>
<li>Multithreaded Correctness：多线程和并发问题。</li>
<li>Malicious Code Vulnerability：恶意代码漏洞。</li>
<li>Security：安全问题。</li>
<li>Experimental：经验性问题。</li>
<li>Internationalization：国际化问题。</li>
</ul>
<p>静态代码分析在一些公司的研发过程中是非常重要的环节，通常用于提交代码后的第一轮检查，如果存在问题，就不会走后面的发布流程。可见，静态代码分析是质量门禁的一部分。<br />在日常工作中，使用 FindBugs 检查并修复代码问题对个人技能的提升也有一定的帮助，能驱使开发者在编写代码时有意识地规避一些潜在的问题。<br />FindBugs 有两种常用的使用方式，使用 IntelliJ IDEA 的插件做本地分析，或者作为 Maven、Gradle 的任务在构建过程中运行。<br>
<a name="wV5Cq"></a></p>
<h4 id="1-使用-IntelliJ-IDEA-的插件-FindBugs">1. 使用 IntelliJ IDEA 的插件 FindBugs</h4>
<p>FindBugs 插件在 IntelliJ IDEA 早期的版本中是独立提供的，后来需要先安装 QAPlug 这个静态代码分析工具，并作为 QAPlug 的一个模块提供。<br />QAPlug 提供了代码分析和扫描的功能，并且能集成 PMD 等诸多模块。不过，使用它们需要同时安装 QAPlug 和 FindBugs 这两个插件，并且要在安装后重启。<br />通过 IDEA 首选项的插件市场即可安装 QAPlug 和 FindBugs，如图 2-1 所示。<br /><img src= "/images/1.webp" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/28066124/1712849919160-207df0e4-84cf-4f99-b001-8a98d59fe0a9.png#clientId=u2f715dd5-4179-4&amp;from=paste&amp;id=u60ab6187&amp;originHeight=987&amp;originWidth=1363&amp;originalType=url&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=148630&amp;status=done&amp;style=none&amp;taskId=u6092c47a-9d99-4bd5-893e-96953cf1415&amp;title=" alt="image.jpg"><br />图 2-1 插件安装<br />这两个插件的使用方法比较简单，参考图 2-2，直接在需要扫描的目录或者模块上点击右键，就会弹出代码分析菜单。<br /><img src= "/images/1.webp" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/28066124/1712849921704-37fa35f7-c2df-4640-a89f-0de063e8aa49.png#clientId=u2f715dd5-4179-4&amp;from=paste&amp;id=u85d2da1e&amp;originHeight=786&amp;originWidth=1363&amp;originalType=url&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=383961&amp;status=done&amp;style=none&amp;taskId=u2c829e6d-5ca7-42fe-b8ae-409be2a418c&amp;title=" alt="image.jpg"><br />图 2-2 代码分析<br />分析完成后，在底部面板中会弹出分析结果，如图 2-3 所示。<br /><img src= "/images/1.webp" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/28066124/1712849918419-4757ead8-6b29-4df4-b743-3a0256b041fd.png#clientId=u2f715dd5-4179-4&amp;from=paste&amp;id=ua1bf36a4&amp;originHeight=381&amp;originWidth=1363&amp;originalType=url&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=84088&amp;status=done&amp;style=none&amp;taskId=u34eae31d-23c9-4ee3-b316-3026a9a0b6e&amp;title=" alt="image.jpg"><br />图 2-3 分析结果<br />从图 2-3 可以看出，这里扫描出代码中存在一个问题，即在某一个方法中使用了浮点类型做数学运算，存在潜在的精度问题。<br>
<a name="veXlu"></a></p>
<h4 id="2-在-Maven-中使用-FindBugs">2. 在 Maven 中使用 FindBugs</h4>
<p>想要在构建过程中使用 FindBugs（如果存在问题可以让构建失败），可以使用 Maven 的插件来运行。<br />创建 Maven 项目后，在 Pom 文件的 build 块中添加 Maven 插件即可开启 FindBugs 功能：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;plugin&gt;</span><br><span class="line">    &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;findbugs-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;3.0.4&lt;/version&gt;</span><br><span class="line">    &lt;configuration&gt;</span><br><span class="line">        &lt;effort&gt;Max&lt;/effort&gt;</span><br><span class="line">    &lt;/configuration&gt;</span><br><span class="line">    &lt;executions&gt;</span><br><span class="line">        &lt;execution&gt;</span><br><span class="line">            &lt;goals&gt;</span><br><span class="line">                &lt;goal&gt;check&lt;/goal&gt;</span><br><span class="line">            &lt;/goals&gt;</span><br><span class="line">        &lt;/execution&gt;</span><br><span class="line">    &lt;/executions&gt;</span><br><span class="line">&lt;/plugin&gt;</span><br></pre></td></tr></table></figure>
<p>在 configuration 属性的配置中，effort 参数比较常用，其含义是使用不同程度的算力进行分析。Effort 参数有 max 和 min 这两个值，使用 max 意味着需要花费更多的内存和时间来找出更多的缺陷；使用 min 则会关闭一些需要花费更多时间和内存的分析项。如果发现运行过程中耗时严重，可以调整这个值。<br />其他参数及其配置方式可以参考 FindBugs 和 FindBugs Maven 插件的相关文档。<br>
<a name="p30Zs"></a></p>
<h4 id="3-FindBugs-的高频错误集合">3. FindBugs 的高频错误集合</h4>
<p>在示例项目中，可能有读者已经找到了 FindBugs 模块，这个模块中提供了一些典型的问题，这些问题在日常修复 FindBugs 时出现的频率较高。即便你不使用 FindBugs，也需要了解这些常见的问题模式，虽然这些问题 IDE 往往也都会提示。<br />**精度问题 **<br />由于计算机通过二进制无法完全表达某些小数，因此会对精度进行取舍，故而我们在使用小数进行数学运算时需要注意精度问题。示例如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">private static void mathCalculate() &#123;</span><br><span class="line">    double number1 = 0.1;</span><br><span class="line">    double number2 = 0.2;</span><br><span class="line">    double number3 = 0.3;</span><br><span class="line">    if (number1 + number2 == number3) &#123;</span><br><span class="line">        System.out.println(&quot;精度问题示例&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>**无限递归调用 **<br />递归程序需要设定基本的结束条件，否则会一直运行下去，直到栈溢出。示例如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public class Person &#123;</span><br><span class="line">    private String name;</span><br><span class="line">    public Person(String name) &#123;</span><br><span class="line">        this.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    public String name() &#123;</span><br><span class="line">        return name();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">Person testPerson = new Person(&quot;test&quot;);</span><br><span class="line">testPerson.name();</span><br></pre></td></tr></table></figure>
<p>**空指针问题 **<br />Java 是完全面向对象的语言，因此我们在使用对象中的成员时需要注意对象是否存在。示例如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">private static void nullIssue() &#123;</span><br><span class="line">    String test = null;</span><br><span class="line">    if (test != null || test.length() &gt; 0) &#123;</span><br><span class="line">        System.out.println(&quot;空指针异常&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    if (test == null &amp;&amp; test.length() &gt; 0) &#123;</span><br><span class="line">        System.out.println(&quot;相反的情况，导致空指针异常&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>**潜在死锁问题 **<br />synchronized 是对象排他锁，而字符串的字面量是整个 JVM 共享的，因此容易造成死锁，我们往往也容易疏忽。示例如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">private static final String lockField = &quot;LOCK_PLACE_HOLDER&quot;;</span><br><span class="line">private static void deadLock() &#123;</span><br><span class="line">    synchronized (lockField) &#123;</span><br><span class="line">        System.out.println(&quot;死锁问题&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>动态的死锁比较难扫描出来，在后面的内容中会专门讨论这个话题。<br />**忘记使用 throw 语句抛出异常 **<br />异常被创建后不使用 throw 语句抛出，编译器并不会报错，但是应该抛出的异常没有被抛出，则可能存在潜在的业务逻辑问题。示例如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">private static void noThrow() &#123;</span><br><span class="line">    boolean condition = false;</span><br><span class="line">    if (condition) &#123;</span><br><span class="line">        // 忘记 throw 一个异常，仅仅创建了</span><br><span class="line">        new RuntimeException(&quot;Dissatisfied condition&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>**相等判定问题 **<br />对象是否相等需要根据具体的逻辑来判断，像基本类型一样简单根据运算符 == 来进行判定并不可靠。示例如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">private static void equalsString() &#123;</span><br><span class="line">    String sting1 = &quot;test&quot;;</span><br><span class="line">    String sting2 = &quot;test&quot;;</span><br><span class="line"></span><br><span class="line">    if (sting1 == sting2) &#123;</span><br><span class="line">        System.out.println(&quot;不安全的相等判定&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>**字符串循环拼接 **<br />字符串是不可变对象，采用字符串循环拼接方式会导致代码性能低下，示例如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">private static void stringConcat() &#123;</span><br><span class="line">    String sting = &quot;test&quot;;</span><br><span class="line">    // 应该使用 String Builder</span><br><span class="line">    for (int i = 0; i &lt; 1000; i++) &#123;</span><br><span class="line">        sting += sting;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>**忘记使用返回值 **<br />在一些方法中，方法不会对参数本身做修改，因此需要接收返回值实现业务逻辑，这部分往往会出现 Bug，示例如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">private static void forgotReturnValue() &#123;</span><br><span class="line">    List&lt;String&gt; list = Arrays.asList(&quot;hello&quot;);</span><br><span class="line">    // map 需要使用返回值</span><br><span class="line">    list.stream().map(String::toUpperCase);</span><br><span class="line">    String hello = &quot;hello  &quot;;</span><br><span class="line">    // 字符串操作也需要返回值</span><br><span class="line">    hello.trim();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>**数组不使用迭代器删除元素 **<br />如果数组不使用迭代器删除元素，而是直接在 for 循环中删除，那么会触发 Concurrent-ModificationException，示例如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">private static void arrayListRemoveException() &#123;</span><br><span class="line">    ArrayList&lt;String&gt; list = new ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    // 直接在 for 循环中删除了元素</span><br><span class="line">    for (String item : list) &#123;</span><br><span class="line">        list.remove(item);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>**资源忘记关闭 **<br />Java 的垃圾回收器只负责处理内存回收，字节流、网络、文件、进程等相关资源都需要手动关闭。比如下面的字节流：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">private static void forgotCloseStream() &#123;</span><br><span class="line">    ByteArrayOutputStream out = new ByteArrayOutputStream();</span><br><span class="line">    ObjectOutputStream s = null;</span><br><span class="line">    // 需要关闭流</span><br><span class="line">    try &#123;</span><br><span class="line">        s = new ObjectOutputStream(out);</span><br><span class="line">        s.writeObject(1);</span><br><span class="line">    &#125; catch (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>**数据截断 **<br />强制类型转换也会存在潜在的 Bug，它会导致数据被截断。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">private static void objectCastIssue() &#123;</span><br><span class="line">    long number = 1000L;</span><br><span class="line">    // 数据会被截断</span><br><span class="line">    int number2 = (int) number;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这些问题都非常常见，通过 FindBugs 基本都可以找出来，如此一来，即可有效地减少代码评审的压力。<br>
<a name="jAvQ9"></a></p>
<h3 id="2-1-3-ArchUnit">2.1.3 ArchUnit</h3>
<p>通过 Checkstyle 解决了代码的风格问题，又使用 FindBugs 解决了基本的代码质量问题，现在还需要解决开发过程中的架构规范问题。<br />有足够经验的开发者都知道，软件项目和架构极其容易腐化。如果没有很好地管控，无论是采用 MVC 的三层架构还是 DDD 的四层架构，代码的结构都会在几个月内变得混乱不堪。<br />我曾经接手过一个项目，它的依赖关系非常混乱。在这个项目中，开发者常常将 API 接口参数的 Request、Response 等对象用于数据库、Redis 存储，这导致架构的下层完全依赖于上层结构。我不得不花费大量的时间和精力进行重构，并且在每日进行 Code Review 时不停地向项目成员强调包结构的重要性，以免项目的新人因为不熟悉情况而随意放置代码。<br />事实上，可以让包结构检查成为自动化检查的一部分，从而节省团队技术经理的管理精力。ArchUnit 作为一个小型、简单、可扩展的开源 Java 测试库，可用于验证预定义的应用程序体系结构和约束关系。<br />在使用 ArchUnit 之前，我们需要讨论一下常见的代码划分包结构的方式。因微服务和单体系统下代码的背景不同，故而不同项目的包结构划分策略也会有所不同，这里按照单体系统下的结构来说明。<br>
<a name="Oysmg"></a></p>
<h4 id="1-常见-的-Java-工程的包结构">1. 常见 的 Java 工程的包结构</h4>
<p>Java 应用项目中一般有两种组织代码的方式。一种是按照 “大平层” 的风格组织，即将同一类代码放到一个包中，比如 Service、Dao；还有一种是按照业务模块来划分，每个模块下有自己的 “大平层”。<br />另外，不同的代码也会有不同的层次划分方式。这里介绍两种，一种是 MVC 风格的三层结构，即 Controller、Service 和 Dao；另外一种是 DDD 的四层结构，即 Interface、Application、Domain 和 Infrastructure。<br />提示：DDD 是领域驱动设计（Domain-driven design）的英文缩写，也指 Eric Evans 在 2003 年所出版的图书《领域驱动设计：软件核心复杂度的解决方法》，该书提出了一种四层的软件分层结构。<br />上述两个维度包含以下 4 种包组织的方式，下面一一说明。<br />**MVC 大平层分包 **<br />这是一种最简单的分包方式，如图 2-4 所示，按照最初 MVC 模式的逻辑，业务应该写在 Controller 中。但是随着前后端分离的发展，View 层消失了。在 Spring Boot 等框架中，Controller 通过 RESTful 的注解代替了 View 层，主流的做法演化成将业务逻辑写在 Service 中。<br /><img src= "/images/1.webp" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/28066124/1712849918284-1dd711cd-00f5-4b1d-bb04-9fd470479c76.png#clientId=u2f715dd5-4179-4&amp;from=paste&amp;id=u2d383674&amp;originHeight=392&amp;originWidth=444&amp;originalType=url&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=14143&amp;status=done&amp;style=none&amp;taskId=u147a2a8e-6270-4626-bdf9-72746055344&amp;title=" alt="image.jpg"><br />图 2-4 MVC 大平层分包<br />为了保持架构整洁，这种分包结构下需要有如下简单规则：</p>
<ul>
<li>相同类型的文件放到相同的包中。</li>
<li>上层对象可以依赖下层对象，禁止反向依赖。</li>
<li>Request 对象只能在 Controller 中使用，为了保持 Service 层的复用性，不允许在 Service 中引用 Controller 层的任何类。</li>
<li>不建议将 Model 直接用于接口的数据输出，而应该转换为特定的 Response 类。</li>
<li>所有文件需要使用包名作为结尾，例如 UserController、UserService、UserModel、UserDao 等。</li>
</ul>
<p>这是一种最简单、清晰的包结构划分，这里还没有涉及枚举、远程调用、工厂等更为细节的包结构设计，可以继续按照需要拓展。<br />**MVC 按照模块分包 **<br />大平层的分包方式在大多数项目中已经够用，但是对于一些复杂的项目，这种包结构会受到团队的质疑，这是因为业务很复杂时，每一个目录下的文件都会非常多。这时，可根据业务划分模块，每个模块下再设置单独的大平层结构，如图 2-5 所示。<br /><img src= "/images/1.webp" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/28066124/1712849918924-5cbf8bdd-90a6-44c0-a35b-ec8a8d301aa7.png#clientId=u2f715dd5-4179-4&amp;from=paste&amp;id=u7f79189b&amp;originHeight=400&amp;originWidth=1156&amp;originalType=url&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=30992&amp;status=done&amp;style=none&amp;taskId=ue44d7c3f-c369-4a80-81ba-8d39a04d637&amp;title=" alt="image.jpg"><br />图 2-5 MVC 按模块分包<br />在规模较大、复杂的应用中按照模块分包，可以将单个开发者的认知负载降低。虽然按照这种方式分包可以将各个业务模块分开，简化单个模块的开发复杂度，但是会让系统整体变得复杂。我们在享受这种分包好处的同时，需要额外注意它带来的问题。例如用户模块的 Controller 可以访问商品模块的 Service，商品模块的 Service 又可以转而访问用户模块的 Dao，随着时间的流逝，虽然各个模块的文件看起来都是分开的，但是业务依然会混乱。<br />为了解决这个问题，在使用这种分包方式时，除了需要遵守上面的规则以外，还需要额外增加如下规则：</p>
<ul>
<li>跨模块访问时，不允许直接访问 Dao，而是应访问对方的 Service。</li>
<li>模块之间应该通过 Service 互相访问，而不是通过表关联。</li>
<li>模块之间不允许存在循环依赖，如果产生循环依赖，应该重新设计。</li>
</ul>
<p>**DDD 大平层分包 **<br />MVC 分包方式虽然能满足大部分项目的需求，但是对于越来越复杂的规模化应用来说，也有一定的局限性。<br />举个例子，当我们的应用需要支持多个角色的操作时，MVC 就会带来一定的混乱。这里的角色不是指管理员和超级管理员那种仅仅是权限不同的角色，而是指管理员、用户、代理商等完全不同的操作逻辑和交互行为。这种思想和 DDD 的分层思想不谋而合。<br />如图 2-6 所示，DDD 的四层结构使用了不同的概念。</p>
<ul>
<li>Interface 层：用于隔离接口差异，即比如 XML、WebSocket、JSON 等。</li>
<li>Application 层：用于隔离应用差异，即将用户的操作和管理员的操作区分开。</li>
<li>Domain 层：用于复用业务逻辑。</li>
<li>Infrastructure 层：一些基础设施，例如数据库、Redis、远程访问等。</li>
</ul>
<p>可以看到， DDD 大平层分包方式划分的包结构和 MVC 区别不算大，主要是将应用层隔离，而将领域层的同类型代码放到一起，使用规则也类似。<br /><img src= "/images/1.webp" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/28066124/1712849918674-57344cbb-1d9c-4fe3-8a20-186ff5ce60ff.png#clientId=u2f715dd5-4179-4&amp;from=paste&amp;id=ubc920be2&amp;originHeight=506&amp;originWidth=754&amp;originalType=url&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=35742&amp;status=done&amp;style=none&amp;taskId=u7c54fc52-aa25-477d-a30a-20fdec92255&amp;title=" alt="image.jpg"><br />图 2-6 DDD 大平层分包<br />**DDD 基于模块分包 **<br />DDD 也可以基于模块分包，如图 2-7 所示，这里的模块划分只会针对于领域对象和领域服务进行，其中涉及一个专门的术语——上下文。<br /><img src= "/images/1.webp" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/28066124/1712849919475-68bc174f-d742-4660-951e-9fad0597514e.png#clientId=u2f715dd5-4179-4&amp;from=paste&amp;id=u048ca57d&amp;originHeight=580&amp;originWidth=772&amp;originalType=url&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=38173&amp;status=done&amp;style=none&amp;taskId=u6e08b77a-af87-4a03-bc28-88a209a98aa&amp;title=" alt="image.jpg"><br />图 2-7 DDD 基于模块分包<br />需要注意的是 ，DDD 基于模块分包并不是一股脑地将所有的 Controller、Service 纳入某个模块中，这种做法会造成业务进一步混乱。它是将应用和领域分开，再按照不同的逻辑进行拆分。<br />DDD 基于模块分包时，需要遵守如下规则：</p>
<ul>
<li>应用可依赖于领域，领域不允许依赖于应用。</li>
<li>上下文之间不允许存在循环依赖。</li>
<li>上下文之间的访问需要通过 Domain Service 完成，不能直接调用对方的数据层。</li>
</ul>
<p>以上四种分包的方式虽然有所不同，但是相差得不多。我们应该根据自己的业务情况来选择分包的方式，如果简单的业务使用较为复杂的包结构，会带来非常多的样板代码，降低开发效率。<br />分层的本质是隔离差异，如果在系统可知的运行时间内没有差异的出现，可以先不考虑分层，这种分层除了人为增加复杂度之外往往没有任何好处。<br />当然，还有洋葱架构、六边形架构等其他架构方式，但是相对小众，这里暂且不做分析。<br />考虑好分包方式后，我们就可以配置 ArchUnit 检查条件和约束规则了。后文将以 “MVC 大平层分包” 方式为例，说明如何使用 ArchUnit 对包结构进行检查。当然，不使用 ArchUnit 也可以通过团队契约、多模块的项目设计对团队开发做一些约束。<br>
<a name="n3Y4m"></a></p>
<h4 id="2-ArchUnit-的原理">2. ArchUnit 的原理</h4>
<p>ArchUnit 利用反射和字节码技术获取所有的包、类、字段等信息，并通过特定的分析来确定对象之间的访问关系。ArchUnit 使用 ASM 作为分析字节码的工具，代价是 ArchUnit 中很多规则的定义不是类型安全的。<br />ArchUnit 支持的检查特性有：</p>
<ul>
<li>包依赖检查。</li>
<li>类依赖检查。</li>
<li>类和包的位置约定检查。</li>
<li>继承检查。</li>
<li>分层依赖检查。</li>
<li>循环依赖检查（Spring 支持双向依赖往往会导致循环现象）。</li>
</ul>
<p>ArchUnit 本身也是按照分层架构设计的，其 API 分为如下三层。</p>
<ul>
<li>Core：核心层，处理一些基本的类、字节码等操作，用于对导入的类进行断言。</li>
<li>Lang：处理各种规则的语法和架构逻辑，并提供一些基本的检查器。</li>
<li>Library：定义一些更为复杂的预定义规则。<br>
<a name="ONVK9"></a></li>
</ul>
<h4 id="3-ArchUnit-使用入门">3. ArchUnit 使用入门</h4>
<p>ArchUnit 的使用比较简单，可以通过 JUnit 的 Runner 运行，也可以通过 Maven、Gradle 等构建工具来运行。下面以 JUnit 作为示例，演示如何使用 ArchUnit。<br />ArchUnit 支持不同的测试框架，这里使用的是 JUnit 4（关于 JUnit，将在下一章介绍）。ArchUnit 更像是进行代码规范的检查而不是测试，虽然它使用了 JUnit 平台，但其实大家更愿意把它划分到静态代码分析中。<br />在 Maven 中使用 ArchUnit，首先需要添加相关的依赖，命令如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;junit&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;junit&lt;/artifactId&gt;</span><br><span class="line">  &lt;version&gt;4.13&lt;/version&gt;</span><br><span class="line">  &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;com.tngtech.archunit&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;archunit&lt;/artifactId&gt;</span><br><span class="line">  &lt;version&gt;0.14.1&lt;/version&gt;</span><br><span class="line">  &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p>在图 2-8 中准备了一个 Demo 应用，它有三个包和三个主要的类。<br /><img src= "/images/1.webp" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/28066124/1712849919086-abce8b79-a203-4160-a99d-04edd6a3018d.png#clientId=u2f715dd5-4179-4&amp;from=paste&amp;id=uce8f3b85&amp;originHeight=320&amp;originWidth=710&amp;originalType=url&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=33163&amp;status=done&amp;style=none&amp;taskId=ub99a8d0d-a9ab-4527-821a-b4a5ac7112f&amp;title=" alt="image.jpg"><br />图 2-8 分层示例<br />我们可以使用下面的规则编写 ArchUnit 测试：</p>
<ul>
<li>Controller 中的类不允许被 Service、Dao 访问。</li>
<li>所有的类名必须使用当前的包名结尾。</li>
</ul>
<p>然后在对应的测试目录下，编写一个测试类 ArchUnitTest，并添加一个测试用例来限制类名，所有的 Controller 文件必须以 Controller 结束：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void file_name_should_end_with_package_name() &#123;</span><br><span class="line">    JavaClasses importedClasses = new ClassFileImporter().importPackages(this.getClass().getPackage().getName());</span><br><span class="line"></span><br><span class="line">    classes().that().resideInAPackage(&quot;..controller&quot;)</span><br><span class="line">            .should().haveSimpleNameEndingWith(&quot;Controller&quot;)</span><br><span class="line">            .check(importedClasses);</span><br><span class="line">    classes().that().resideInAPackage(&quot;..service&quot;)</span><br><span class="line">            .should().haveSimpleNameEndingWith(&quot;Service&quot;)</span><br><span class="line">            .check(importedClasses);</span><br><span class="line">    classes().that().resideInAPackage(&quot;..dao&quot;)</span><br><span class="line">            .should().haveSimpleNameEndingWith(&quot;Dao&quot;)</span><br><span class="line">            .check(importedClasses);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在上述代码中，importedClasses 为被覆盖的范围，ArchUnit 可以通过 ClassFileImporter、JavaTypeImporter 等方式加载需要被验证的类。<br />上面这段测试中包含了 3 条验证规则，下面这段代码就是其中一条。使用 ArchUnit 只需要按照类似的做法编写这些规则即可。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">classes().that().resideInAPackage(&quot;..controller&quot;)</span><br><span class="line">            .should().haveSimpleNameEndingWith(&quot;Controller&quot;)</span><br><span class="line">            .check(importedClasses);</span><br></pre></td></tr></table></figure>
<p>这是一个典型链式风格的 API，classes() 方法是 ArchUnit lang 层的工具方法，用于声明基本的规则，大部分基本规则都可以使用 classes() 方法来初始化声明。that() 方法后面的内容代表哪些符合规则的类会被筛选到。ArchUnit 提供了大量的筛选器，比如类型、是否使用了某种注解等。should() 方法后面接的是断言规则，比如类名规则、依赖规则等。<br />接下来实现 MVC 分层架构的依赖检查，这里会用到 library 包中的预定义规则方法 layeredArchitecture()，示例代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void should_obey_MVC_architecture_rule() &#123;</span><br><span class="line"> JavaClasses importedClasses = new ClassFileImporter().importPackages(this.getClass().getPackage().getName());</span><br><span class="line">    layeredArchitecture()</span><br><span class="line">            .layer(&quot;Controller&quot;).definedBy(&quot;..controller..&quot;)</span><br><span class="line">            .layer(&quot;Service&quot;).definedBy(&quot;..service..&quot;)</span><br><span class="line">            .layer(&quot;Dao&quot;).definedBy(&quot;..dao..&quot;)</span><br><span class="line"></span><br><span class="line">            .whereLayer(&quot;Controller&quot;).mayNotBeAccessedByAnyLayer()</span><br><span class="line">            .whereLayer(&quot;Service&quot;).mayOnlyBeAccessedByLayers(&quot;Controller&quot;)</span><br><span class="line">            .whereLayer(&quot;Dao&quot;).mayOnlyBeAccessedByLayers(&quot;Service&quot;);</span><br><span class="line">  layeredArchitecture.check(importedClasses);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行上述代码时，在 IDEA 编辑器边缘会出现绿色的运行按钮，单击此按钮即可作为单元测试运行。这里使用 layeredArchitecture() 将 controller、service 和 dao 三个包中的类分别定义为 Controller、Service 和 Dao 层，并声明其约束关系。如果出现错误的依赖关系，测试就不会通过。<br />官网使用了一张图来说明三层架构下的依赖关系（如图 2-9 所示），可以看到，这里只允许下层类被上层调用，以此来守护代码的架构。在编写本书时，官网的示例代码存在部分未更新的情况，如果按照官网的说明不能运行，可以参考本书提供的示例代码。<br /><img src= "/images/1.webp" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/28066124/1712849920297-873407a6-37f4-45fd-88f1-d96a583fed65.png#clientId=u2f715dd5-4179-4&amp;from=paste&amp;id=ucc5a5ced&amp;originHeight=1076&amp;originWidth=1254&amp;originalType=url&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=162070&amp;status=done&amp;style=none&amp;taskId=u6bd5214d-d705-482f-9f86-b98f9dd2308&amp;title=" alt="image.jpg"><br />图 2-9 ArchUnit 的依赖示意图<br />（注：图片来源于 <a target="_blank" rel="noopener" href="https://www.archunit.org/%EF%BC%89">https://www.archunit.org/）</a><br>
<a name="dbHAX"></a></p>
<h3 id="2-1-4-OWASP-Dependency-Check">2.1.4 OWASP Dependency-Check</h3>
<p>架构的问题解决后，还需要避免在项目中使用开源软件带来的安全问题。开放式 Web 应用程序安全项目（OWASP）是一个非营利组织，提供了安全标准、数据库、社区和培训。其中一个工具 OWASP Dependency-Check 可以对第三方依赖包中的知名漏洞进行检查，扫描结果受漏洞数据库的更新影响。<br />OWASP Dependency-Check 可以报告现有的第三方依赖的 CVE。CVE 的英文全称是 Common Vulnerabilities &amp; Exposures，可以简单地理解为业界已知的漏洞批漏。<br />OWASP 的安全扫描和 fortify 等安全扫描工具有所不同，它依赖于开放的漏洞信息，不能完全代替模式分析类安全扫描工具。即便如此，基于 OWASP Dependency-Check 进行的依赖检查也是必须的，因为现代项目依赖的组件较多，通过人工检查的方式较难及时发现漏洞。<br />OWASP 的依赖检查支持主流的语言和包管理工具，对于 Java 语言来说，我们可以继续使用 Maven 插件来运行 OWASP Dependency-Check。与 Checkstyle 类似，首先创建一个模块，在 Pom 文件中添加相关依赖：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;plugin&gt;</span><br><span class="line">    &lt;groupId&gt;org.owasp&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;dependency-check-maven&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;6.1.3&lt;/version&gt;</span><br><span class="line">    &lt;executions&gt;</span><br><span class="line">        &lt;execution&gt;</span><br><span class="line">            &lt;goals&gt;</span><br><span class="line">                &lt;goal&gt;check&lt;/goal&gt;</span><br><span class="line">            &lt;/goals&gt;</span><br><span class="line">        &lt;/execution&gt;</span><br><span class="line">    &lt;/executions&gt;</span><br><span class="line">&lt;/plugin&gt;</span><br></pre></td></tr></table></figure>
<p>在真实的项目中，依赖包的变化没有那么频繁，如果每次构建都运行这个检查会让构建变慢。比较好的做法是使用 CI/CD 工具，比如 Jenkins，设定一个定时的任务在夜间运行。关于 Jenkins 的使用，请参考本书测试工程化部分。<br />使用 OWASP Dependency-Check 时需要意识到，它并不能取代安全测试。由于它的实现机制是通过 CVE 库来报告问题的，因此受制于该库的更新情况，存在一定程度上的滞后问题。<br>
<a name="Tr6su"></a></p>
<h2 id="2-2-代码评审">2.2 代码评审</h2>
<p>这里的代码评审是指人工查看代码是否存在问题或者改进点，人工进行代码评审更加关注设计，因为代码的设计往往不能被自动化的静态代码分析发现。比如，团队某个成员编写的代码使用了拼音作为变量名，虽然能通过静态代码分析，但这不是一个好的设计，不良的命名方法会让代码的可读性大大降低。<br>
<a name="t5jcn"></a></p>
<h3 id="2-2-1-代码评审的场景">2.2.1 代码评审的场景</h3>
<p>代码评审是国际软件业界公认的最有效的软件工程实践之一，人工代码评审和测试的不同点在于，人工代码评审不只是发现代码中的错误，它还能预防一些错误的发生。<br />我们可通过纠正开发者的编码习惯和风格，来提高软件的质量。举个例子，如果没有为关键程序添加事务处理机制，那么测试人员往往不会测试出问题，但是在高并发的情况下会有一定的机会暴露缺乏此机制的问题。在代码评审阶段，若能及时发现团队成员没有增加事务相关的注解，就能避免潜在问题的出现。代码评审也让团队的协作风格趋于统一，我们可以在评审过程中整理一些代码规范，让团队成员按照相似的风格进行开发。<br />综上所述，虽然我们可以在一定程度上使用静态代码分析来保证代码质量，但静态代码分析无法解决所有问题，因此不能完全依赖于它，在一些场景中我们需要让团队成员一起来做代码评审。<br />在团队日常的开发工作中，有如下几种代码评审方式。<br />1）** 每日代码评审。** 一般是在每天下午下班前拿出 1 个小时来对当天的代码做评审。如果一个团队共有 8 个成员，那么相当于需要花费一个人天。有一些项目经理特别不理解为什么需要花时间来做这件事情。实际上，每日代码评审非常重要，不仅可以分摊需要评审的代码量，也可以让团队的编码风格日趋统一，如此往复需要指出的错误就会越来越少。此外，每日代码评审也是团队进行技术交流的一个契机，团队成员彼此之间可以清晰地了解对方在做什么。<br />2）** 发布前代码评审。** 发布前进行代码评审的目的是避免产品中有明显不合适的代码。有时候一些错误测试人员很有可能没有覆盖住，而通过发布前代码评审就能快速识别。如果团队的版本管理策略是在 Release 分支上发布，那么通过与另一个分支上之前发布的版本对比，也就可以看出两者之间的差异。发布前代码评审的工作量比较大，一些创业团队不愿意做是可以理解的，对于成熟的公司，如果是有大量用户的产品，则需要认真进行此评审。<br />3）<strong>Hotfix 代码评审。</strong> 一个新版本发布后，往往会有一些问题需要及时修复，我们将这种修复叫作 Hotfix。Hotfix 通常不会改动太多地方，测试人员也无力全部进行回归测试，所以 Hotfix 一般是通过 Pull Request 来完成的，在此过程中，会由有经验的技术经理来把关合入的代码是否存在明显的问题。<br />一般来说，上述三种主要的代码评审方式都发生在团队内部。其中，每日代码评审和发布前的代码评审通常需要团队成员一起参加，对此，可以使用一个大屏配合 IDE 在本地完成。<br>
<a name="vn1xW"></a></p>
<h3 id="2-2-2-代码评审的工具">2.2.2 代码评审的工具</h3>
<p>代码评审基于如下工具来进行可以提高效率。</p>
<ul>
<li>代码版本管理工具，比如 Git、SVN、Mercurial 等，不过目前大都使用 Git 。Git 的分布式特性很出色，工具链也完善，如果没有别的限制因素，可以默认使用 Git。</li>
<li>代码托管平台，GitLab、Github 以及国内的 Gitee 都不错，如果在企业内部使用，可以选择自己搭建 GitLab，不过 GitLab 比较复杂，因此也可以使用 Gogs 通过 Docker 容器快速启动一套 Git 代码托管平台。</li>
<li>代码对比工具。代码托管平台一般会提供内置的代码对比工具，不过访问比较慢。还有专业的代码对比工具软件（比如 BeyondCompare），以及集成到 IDE Git 客户端中的代码对比工具（比如 IntelliJ IDEA 等）。IntelliJ IDEA 在大部分项目中完全够用，而且在多人参与的代码评审活动中效率也比较高。</li>
<li>专用的代码评审工具。这类工具是专门为代码评审而设计的，比如 Gerrit。Gerrit 可以在网页中做类似于 GitLab、Github 的工作，而且还有一些额外的工作流管理能力。</li>
</ul>
<p>一般来说，对于非开源项目，GitLab 与 IntelliJ IDEA 是一个比较好的工具组合，配置和使用简单，维护成本也比较低。<br>
<a name="jBBKc"></a></p>
<h3 id="2-2-3-代码评审的注意事项">2.2.3 代码评审的注意事项</h3>
<p>一般来说，代码评审对技巧的要求不高，根据团队的习惯和风格审核即可。历史上可以追溯的代码评审方法有 IBM 公司在 1972 年提出的培根法。培根法将代码评审的参与人分为代码作者、审查者和主持人，这些人员组成评审委员会。<br />培根法要求先由代码作者进行代码叙述，然后由审查者提出问题。审查者需要提前阅读代码，并准备问题。由于培根法评审的速度实在太慢，采用此方法的团队并不多。IBM 表示他们在一些关键的模块中使用了这种方法，最终带来的收益并不低。据统计，由于减少了项目后期修改和返工的时间，代码评审使得项目的开发时间反而提前了 30%。<br />对于普通的团队，还是建议根据场景来制定合适的评审策略，在成本和收益之间权衡。下面是根据不同场景提出的代码评审注意事项。<br>
<a name="LScCh"></a></p>
<h4 id="1-每日代码评审">1. 每日代码评审</h4>
<p>一般我们讨论得比较多的是每日代码评审，因为需要全员参与，时间又比较有限，因此主持人要有较强的组织能力，而且为了高效地进行代码评审，团队也需要达成一些契约。<br />**（1）小步提交 <strong><br />团队成员需要保持良好的代码提交习惯——小步提交代码。每完成一个小阶段的开发或重构工作都需要提交一次代码，在避免更改丢失的同时也可为更好地评审代码打下基础。每一次的提交都需要使用有意义、风格一致的文本描述，也需要遵守相应的规则，比如使用看板卡片管理任务的团队会按照 “# [卡号] [描述]” 的模式提交代码。<br /></strong>（2）描述要具体 <strong><br />在进行代码评审的时候避免使用诸如 “这个地方的实现不优雅” 这类似是而非的用语，应该使用更为具体的表述，比如 “使用了太多的 if 语句，是否可以使用策略模式等设计模式改进设计”。此外，还要避免提出带有个人习惯的意见，例如 &quot;应该使用 switch 语句而非多个 if 语句” 等。<br /></strong>（3）及时修改 <strong><br />代码评审过程中提出的问题，需要代码作者自行记录，并且尽可能在当天完成修复和处理。一些零碎的小事放到以后做都是不现实的。<br /></strong>（4）专注参与 <strong><br />如果是线下评审，最好使用大屏或专门的会议室，避免大家一边进行代码评审一边做其他的事情。如果是远程工作，通过视频会议评审，则建议所有人打开摄像头，主持人可以使用一些主持技巧，比如不定时对部分参与人员点名，唤起大家的注意力。<br /></strong>（5）聚焦当下 <strong><br />最糟糕的代码评审就是突然岔开话题，进行技术方案、业务方案的讨论，这会浪费大家的时间。如果话题被岔开，那将会是一个无底洞，就像《爱丽丝梦游仙境》中兔子洞的故事（Rabbit Hole）所描述的一样。代码评审应该专注于当下的代码问题，避免陷入技术和业务细节，如果遇到这种情况，可以提出在专门的技术会议中讨论。<br /></strong>（6）控制好时间 <strong><br />代码评审中最难的就是时间控制，一般一个正常的开发团队每天每人的工作量至少需要 10 分钟才能描述清楚，因此，需要给每个人设定一个时间窗口，避免超时。一般来说可根据人数设定时间，如果超时了，就立马停止，第二天继续，这样会越来越快。<br /></strong>（7）分组评审 <strong><br />如果团队规模过大，无论如何也无法在 1 个小时内完成评审，就需要进行分组。为了让所有的开发者都能了解全局，以及保持知识传递，可以按周、迭代频率等重新分组。<br /></strong>（8）知识整理 **<br />重复出现的问题不应该被重复提出，对于一些常见的问题，团队可以整理一份评审清单，当有新人参与项目时，评审清单有利于其更快地适应团队风格，也可以降低发现问题的成本和偶然性，同时开发者在提交代码的时候也可以参考清单自己先评审一遍。<br>
<a name="MbGGl"></a></p>
<h4 id="2-发布前的代码评审">2. 发布前的代码评审</h4>
<p>发布前的代码评审不用全员参与，可以由技术经理挑选几个关键人员参加，如果遇到无法理解的部分，可以邀请提交人来进一步解释。发布前的代码评审着重于处理对线上具有破坏性的修改，从而避免一些危害。<br />此外，它还可以发现因管理问题带来的线上游离变更，比如前一个迭代进行了 Hotfix，但是没有及时合并到主干上，导致生产上有相关代码但是当前发布的版本中却没有，这样一来，发布完成后就会出现问题。<br>
<a name="JI8Kp"></a></p>
<h4 id="3-Hotfix-代码评审">3. Hotfix 代码评审</h4>
<p>Hotfix 代码评审比较简单，一般在代码托管平台中对 Pull Request 进行设定即可，比如，必须有多少人通过才允许合并等。此外，通过 Pull Request 也可以追溯 Hotfix 的变更记录。<br />在一些管理严格的公司中，Hotfix 还需要经过多级审核才发布，毕竟对于 Hotfix 来说，全量执行手动的回归测试不太现实，所以折中的方法是对变更的代码进行严格评审。<br>
<a name="zE3R9"></a></p>
<h3 id="2-2-4-Java-代码评审清单">2.2.4 Java 代码评审清单</h3>
<p>这里为 Java 开发者整理了一份基本的评审清单，为了避免清单冗长，里面不包含静态扫描能发现的问题，具体如下：</p>
<ul>
<li>有没有 IntelliJ IDEA 的黄色警告。若存在黄色警告，往往意味着代码可以被优化或者存在潜在的问题。</li>
<li>数据的输入是否进行了验证，比如类型、长度、格式、范围等。</li>
<li>提供的 API 是否做了鉴权，尤其是数据的鉴权。</li>
<li>需要配置的值是否是硬编码，需要使用常量或配置文件存放配置。</li>
<li>注释和方法的命名是否与代码语义一致并容易理解。</li>
<li>是否使用了足够便捷的解决方案，比如库函数已提供的逻辑就不需要自己再写一遍了。</li>
<li>是否使用适当的数据结构，比如合理选择 HashMap、ArrayList 等。</li>
<li>是否做了合理的异常处理。</li>
<li>API 的设计是否符合规范和语义。</li>
<li>是否有足够多且合理的测试。<br>
<a name="AT6EV"></a></li>
</ul>
<h2 id="2-3-Git-工作流和保护">2.3 Git 工作流和保护</h2>
<p>Git 作为一款出色的分布式代码版本管理工具，由 Linux 的作者 Linus 开发，目前，它已经成为我们日常开发离不开的工具。用好 Git，并且采用适当的工作流，可以让代码评审工作事半功倍。<br>
<a name="e9xe1"></a></p>
<h3 id="2-3-1-Git-工作流">2.3.1 Git 工作流</h3>
<p>在团队协作中，代码评审的方式和代码版本管理有一定关系，代码版本管理的工作流和分支策略是一个讨论比较多的话题。Git 工作流说明了团队如何使用 Git 分支，并按照一定约定进行协作。Git 工作流有很多派别，比如 Git Flow、GitHub Flow、GitLab Flow 等。</p>
<ul>
<li>Git Flow：项目存在两个长期分支，即一个主干分支，一个开发分支，开发者一起工作在开发分支中，发布时合并到主干分支中。此外，还有一些短期存在的分支，比如特性分支、预发分支等。</li>
<li>GitHub Flow：项目以一个主干分支作为长期分支，每个开发者在自己的开发分支中工作，然后通过 Pull Request 合并到主干分支。</li>
<li>GitLab Flow：项目遵守上游优先原则，只以一个主分支作为长期分支。开发者在主干分支上开发，待测试稳定后，使用发布分支发布。后续的 Hotfix 都需要合并到发布分支和主分支上。</li>
</ul>
<p>从实用和经济的角度来说，个人比较推荐 GitLab Flow，当然，具体应该视团队情况而定，比如团队人数、是否需要和其他团队联调（这是个比较重要的因素，若使用分支开发会比较麻烦）等。<br />如图 2-10 所示，对于大多数使用敏捷工作方式的团队来说，比较好的分支策略可以用一句话概括：** 主干开发，分支发布 **。这种策略尤其适合一个迭代一个版本的开发节奏，但如果采用的是持续发布方式，因为这种方式没有固定的版本周期，所以此策略未必合适。<br /><img src= "/images/1.webp" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/28066124/1712849919919-aeaf6d9a-c85d-435e-9e5e-d64751e726da.png#clientId=u2f715dd5-4179-4&amp;from=paste&amp;id=uceed5d4c&amp;originHeight=272&amp;originWidth=998&amp;originalType=url&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=26195&amp;status=done&amp;style=none&amp;taskId=ua38a96d1-3fcf-4ffc-bf3d-1d0cdea6822&amp;title=" alt="image.jpg"><br />图 2-10 一种分支策略<br />“主干开发，分支发布” 的分支策略有以下几个规则需要团队遵守：</p>
<ul>
<li>团队应使用 Git rebase 命令而不是 merge 命令拉取代码，以避免提交日志混乱。</li>
<li>团队在主干开发，每个迭代结束的前几天创建 Release 分支，每一次发布使用一个新的分支，应使用语义化版本号（Semantic Versioning）[^1] 来命名，比如 v2.1 分支。创建 Release 分支时可以同步创建标签，以便早期发布的 Release 分支可以被删除。</li>
<li>Release 分支可以部署到预发环境中，主干只能部署到开发和测试环境。</li>
<li>在将 Release 分支发布到产品环境之前，要基于上一次的 Release 分支做发布前的代码评审。</li>
<li>如果预发环境出现问题需要修复，以 Release 分支为基线创建 Hotfix 分支，并提交 Pull Request，团队批准后可以先部署到预发环境中，再部署到产品环境中。</li>
<li>部署到产品环境后，需要将 Release 分支的变更同步到主干，避免下次上线丢失更新。<br>
<a name="oOGE5"></a></li>
</ul>
<h3 id="2-3-2-Git-Hooks">2.3.2 Git Hooks</h3>
<p>静态代码分析和代码评审需要与代码的分支控制相结合才能起到好的效果，如果 Checkstyle 等检查没有通过，代码不应被推送到 Git 服务器上。<br />Git Hooks 是由 Shell 脚本构成的。Hook（钩子）这个概念在操作系统和带有插件系统的软件中广泛存在，这里将其用于 Git 的某个生命周期。所有默认有效的钩子都可以在. git/hooks / 目录中找到。钩子用于控制 Git 工作的流程时，又分为客户端钩子和服务器钩子，客户端钩子会在执行 push 命令之前运行在开发者的本地机器上，服务器钩子会在推送后运行在 Git 服务器上。<br />下面是一些常见的客户端和服务器钩子。客户端钩子：</p>
<ul>
<li>pre-commit</li>
<li>prepare-commit-msg</li>
<li>commit-msg</li>
<li>post-commit</li>
</ul>
<p>服务器端钩子：</p>
<ul>
<li>pre-receive</li>
<li>post-receive</li>
<li>update</li>
</ul>
<p>一般我们会通过配置 pre-commit 到项目中，来促使团队成员在提交代码时进行一些检查，所进行的检查包括：</p>
<ul>
<li>运行单元测试。</li>
<li>运行代码检查（比如 Checkstyle）。</li>
<li>提交的信息检查。</li>
</ul>
<p>如果有 Git 服务器的配置权限，也可以通过配置 pre-receive 在服务器端运行检查。本地检查无疑是最高效且方便的手段之一，但是组织一群人来手动安装这类脚本明显是一件费力不讨好的事。为了防止团队成员忘记设置本地钩子脚本，我们可以在构建工具中添加安装钩子脚本的任务，让开发者在第一次启动项目时自动添加相关钩子。<br />由于几乎所有的 Maven 使用者都会执行 mvn install 命令来初始化项目，因此可以使用插件 git-build-hook 来安装 Hook 脚本，示例代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;build&gt;</span><br><span class="line">  &lt;plugins&gt;</span><br><span class="line">    &lt;plugin&gt;</span><br><span class="line">      &lt;groupId&gt;com.rudikershaw.gitbuildhook&lt;/groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;git-build-hook-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">      &lt;version&gt;3.1.0&lt;/version&gt;</span><br><span class="line">      &lt;configuration&gt;</span><br><span class="line">        &lt;gitConfig&gt;</span><br><span class="line">          &lt;!-- 指定代码库中的 Hook 脚本位置，插件会帮助安装到 gitconfig 中 --&gt;</span><br><span class="line">          &lt;core.hooksPath&gt;hooks-directory/&lt;/core.hooksPath&gt;</span><br><span class="line">          &lt;custom.configuration&gt;true&lt;/custom.configuration&gt; </span><br><span class="line">        &lt;/gitConfig&gt;</span><br><span class="line">      &lt;/configuration&gt;</span><br><span class="line">      &lt;executions&gt;</span><br><span class="line">        &lt;execution&gt;</span><br><span class="line">          &lt;goals&gt;       </span><br><span class="line">            &lt;!-- 配置执行 Hook 安装的生命中周期 --&gt;</span><br><span class="line">            &lt;goal&gt;install&lt;/goal&gt;</span><br><span class="line">          &lt;/goals&gt;</span><br><span class="line">        &lt;/execution&gt;</span><br><span class="line">      &lt;/executions&gt;</span><br><span class="line">    &lt;/plugin&gt;</span><br><span class="line">  &lt;/plugins&gt;</span><br><span class="line">&lt;/build&gt;</span><br></pre></td></tr></table></figure>
<p>将上面的配置放置到相应的 Pom 文件中，团队成员执行了 mvn install 命令后，钩子脚本就会自动安装。如果下一次团队成员使用 Git 相应命令提交和推送代码，就会触发相应的钩子脚本。<br />下面是一个触发钩子脚本的示例，把这个文件保存为 pre-commit 并放到 hooks-directory 目录中，项目初始化后，在提交代码时此脚本就会被执行。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line"># 需要运行的命令</span><br><span class="line">mvn clean build</span><br><span class="line"># 获取上一个命令的执行结果</span><br><span class="line">RESULT=$?</span><br><span class="line"># 使用上一个命令的执行结果来退出，这样做可以选择是否中断构建</span><br><span class="line">exit $RESULT</span><br></pre></td></tr></table></figure>
<p>Gradle 可以更灵活地编写、构建脚本和任务，下面是 Java Gradle 的一个 pre-commit 脚本示例，在项目的根目录中添加 pre-commit 文件，通过配置 Gradle 脚本可以使项目初始化时自动安装该钩子。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">task installGitHooks(type: Copy) &#123;</span><br><span class="line">    from new File(rootProject.rootDir, &#x27;pre-commit&#x27;)</span><br><span class="line">    into &#123;</span><br><span class="line">        new File(rootProject.rootDir, &#x27;.git/hooks&#x27;)</span><br><span class="line">    &#125;</span><br><span class="line">    fileMode 0755</span><br><span class="line">&#125;</span><br><span class="line">build.dependsOn installGitHooks</span><br></pre></td></tr></table></figure>
<p><a name="pqyDZ"></a></p>
<h3 id="2-3-3-分支保护">2.3.3 分支保护</h3>
<p>在没有 Pull Request 和代码评审的情况下，不应该把代码直接推送到 Release 分支。因为 Git 代码托管平台有分支保护功能，所以可以基于前面的分支策略设定几个简单的规则。</p>
<ul>
<li>受保护的分支均不可删除、强制推送，避免代码库受损。</li>
<li>Release 分支不接受直接推送，必须使用 Pull Request 的方式提交补丁合并，并需要在 2 人以上的团队成员批准后才能合并。</li>
<li>如果条件允许，合并到 Release 分支的临时分支可以自动删除。</li>
</ul>
<p>图 2-11 是 GitLab 的分支保护界面，配置好分支保护以后，就可以避免因为误操作或者恶意操作导致团队的代码库丢失。<br /><img src= "/images/1.webp" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/28066124/1712849919689-6220a81a-dcbc-4e30-94da-e76b5885c328.png#clientId=u2f715dd5-4179-4&amp;from=paste&amp;id=u41fb5ef7&amp;originHeight=326&amp;originWidth=1363&amp;originalType=url&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=66690&amp;status=done&amp;style=none&amp;taskId=u2f059dae-c58a-4cc8-a5bb-52684c09bc5&amp;title=" alt="image.jpg"><br />图 2-11 GitLab 的分支保护设置<br>
<a name="Et5Ay"></a></p>
<h2 id="2-4-小结">2.4 小结</h2>
<p>本章介绍了代码评审的几种形式，包括静态代码分析和人工代码评审。基于静态代码分析的各种工具，可以低成本地提高静态代码分析的能力和效果。<br />为了弥补静态代码分析的不足，可以根据场景对代码进行评审，评审也是团队整体学习的契机。提高代码质量、互相学习、知识共享是每日代码评审的动力，保持节奏感和坚持是从中获益的必要条件。<br />最后，为了更高效地实现静态代码分析和代码评审，我们需要基于适合团队的版本管理工作流来实现更好地团队协作。主流的版本管理方式有 Git Flow、GitHub Flow、GitLab Flow 等，具体需要根据产品类型和规模进行选择，我们也可以定制适合自己的版本管理工作流。此外，通过 Git Hooks 和分支保护可以充分地挖掘 Git 的潜力，让团队协作更安全和流畅。<br />[^1]: 参考网站 <a target="_blank" rel="noopener" href="https://semver.org/">https://semver.org/</a></p>
<blockquote>
<p>来自: <a target="_blank" rel="noopener" href="https://java-self-testing.github.io/java-self-testing-book/02-code-review/">第 2 章 代码评审 - 《Java 研发自测》</a></p>
</blockquote>
<meta name="referrer" content="no-referrer">
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://www.bojiboqi.fun">山麋一笑</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://www.bojiboqi.fun/2024/04/22/%E7%AC%AC%202%20%E7%AB%A0%20%E4%BB%A3%E7%A0%81%E8%AF%84%E5%AE%A1%20-%20%E3%80%8AJava%20%E7%A0%94%E5%8F%91%E8%87%AA%E6%B5%8B%E3%80%8B/">http://www.bojiboqi.fun/2024/04/22/%E7%AC%AC%202%20%E7%AB%A0%20%E4%BB%A3%E7%A0%81%E8%AF%84%E5%AE%A1%20-%20%E3%80%8AJava%20%E7%A0%94%E5%8F%91%E8%87%AA%E6%B5%8B%E3%80%8B/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://www.bojiboqi.fun" target="_blank">山麋一笑</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/spring%E6%B5%8B%E8%AF%95/">spring测试</a></div><div class="post_share"><div class="social-share" data-image="/img/wakawaka/IMG_20240309_203909_595.webp" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/04/22/%E7%AC%AC%201%20%E7%AB%A0%20%E7%A0%94%E5%8F%91%E8%87%AA%E6%B5%8B%E5%9F%BA%E7%A1%80%20-%20%E3%80%8AJava%20%E7%A0%94%E5%8F%91%E8%87%AA%E6%B5%8B%E3%80%8B/" title="第 1 章 研发自测基础 - 《Java 研发自测》"><img class="cover" src= "/images/1.webp" data-lazy-src="/img/wakawaka/IMG_20240309_204857_906.webp" onerror="onerror=null;src='/img/404.png'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">第 1 章 研发自测基础 - 《Java 研发自测》</div></div></a></div><div class="next-post pull-right"><a href="/2024/04/22/%E7%AC%AC%204%20%E7%AB%A0%20%E6%B5%8B%E8%AF%95%E6%9B%BF%E8%BA%AB%20-%20%E3%80%8AJava%20%E7%A0%94%E5%8F%91%E8%87%AA%E6%B5%8B%E3%80%8B/" title="第 4 章 测试替身 - 《Java 研发自测》"><img class="cover" src= "/images/1.webp" data-lazy-src="/img/wakawaka/IMG_20240309_174442_056.webp" onerror="onerror=null;src='/img/404.png'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">第 4 章 测试替身 - 《Java 研发自测》</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2024/04/22/%E7%AC%AC%201%20%E7%AB%A0%20%E7%A0%94%E5%8F%91%E8%87%AA%E6%B5%8B%E5%9F%BA%E7%A1%80%20-%20%E3%80%8AJava%20%E7%A0%94%E5%8F%91%E8%87%AA%E6%B5%8B%E3%80%8B/" title="第 1 章 研发自测基础 - 《Java 研发自测》"><img class="cover" src= "/images/1.webp" data-lazy-src="/img/wakawaka/IMG_20240309_204857_906.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-22</div><div class="title">第 1 章 研发自测基础 - 《Java 研发自测》</div></div></a></div><div><a href="/2024/04/22/%E7%AC%AC%204%20%E7%AB%A0%20%E6%B5%8B%E8%AF%95%E6%9B%BF%E8%BA%AB%20-%20%E3%80%8AJava%20%E7%A0%94%E5%8F%91%E8%87%AA%E6%B5%8B%E3%80%8B/" title="第 4 章 测试替身 - 《Java 研发自测》"><img class="cover" src= "/images/1.webp" data-lazy-src="/img/wakawaka/IMG_20240309_174442_056.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-22</div><div class="title">第 4 章 测试替身 - 《Java 研发自测》</div></div></a></div><div><a href="/2024/04/22/%E7%AC%AC%205%20%E7%AB%A0%20Spring%20%E5%BA%94%E7%94%A8%E7%9A%84%E6%B5%8B%E8%AF%95%20-%20%E3%80%8AJava%20%E7%A0%94%E5%8F%91%E8%87%AA%E6%B5%8B%E3%80%8B/" title="第 5 章 Spring 应用的测试 - 《Java 研发自测》"><img class="cover" src= "/images/1.webp" data-lazy-src="/img/wakawaka/photo_2024-02-28_19-54-01.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-22</div><div class="title">第 5 章 Spring 应用的测试 - 《Java 研发自测》</div></div></a></div><div><a href="/2024/04/22/%E7%AC%AC%206%20%E7%AB%A0%20RESTful%20API%20%E6%B5%8B%E8%AF%95%20-%20%E3%80%8AJava%20%E7%A0%94%E5%8F%91%E8%87%AA%E6%B5%8B%E3%80%8B/" title="第 6 章 RESTful API 测试 - 《Java 研发自测》"><img class="cover" src= "/images/1.webp" data-lazy-src="/img/wakawaka/photo_2024-02-28_19-42-15.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-22</div><div class="title">第 6 章 RESTful API 测试 - 《Java 研发自测》</div></div></a></div></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E5%B8%B8%E7%94%A8%E7%9A%84%E9%9D%99%E6%80%81%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7"><span class="toc-number">1.</span> <span class="toc-text">2.1 常用的静态代码分析工具</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-1-Checkstyle"><span class="toc-number">1.1.</span> <span class="toc-text">2.1.1 Checkstyle</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%9C%A8-Maven-%E4%B8%AD%E4%BD%BF%E7%94%A8-Checkstyle"><span class="toc-number">1.1.1.</span> <span class="toc-text">1. 在 Maven 中使用 Checkstyle</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E8%87%AA%E5%AE%9A%E4%B9%89%E4%BB%A3%E7%A0%81%E9%A3%8E%E6%A0%BC%E6%A3%80%E6%9F%A5%E8%A7%84%E5%88%99"><span class="toc-number">1.1.2.</span> <span class="toc-text">2. 自定义代码风格检查规则</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-2-FindBugs"><span class="toc-number">1.2.</span> <span class="toc-text">2.1.2 FindBugs</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E4%BD%BF%E7%94%A8-IntelliJ-IDEA-%E7%9A%84%E6%8F%92%E4%BB%B6-FindBugs"><span class="toc-number">1.2.1.</span> <span class="toc-text">1. 使用 IntelliJ IDEA 的插件 FindBugs</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%9C%A8-Maven-%E4%B8%AD%E4%BD%BF%E7%94%A8-FindBugs"><span class="toc-number">1.2.2.</span> <span class="toc-text">2. 在 Maven 中使用 FindBugs</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-FindBugs-%E7%9A%84%E9%AB%98%E9%A2%91%E9%94%99%E8%AF%AF%E9%9B%86%E5%90%88"><span class="toc-number">1.2.3.</span> <span class="toc-text">3. FindBugs 的高频错误集合</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-3-ArchUnit"><span class="toc-number">1.3.</span> <span class="toc-text">2.1.3 ArchUnit</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%B8%B8%E8%A7%81-%E7%9A%84-Java-%E5%B7%A5%E7%A8%8B%E7%9A%84%E5%8C%85%E7%BB%93%E6%9E%84"><span class="toc-number">1.3.1.</span> <span class="toc-text">1. 常见 的 Java 工程的包结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-ArchUnit-%E7%9A%84%E5%8E%9F%E7%90%86"><span class="toc-number">1.3.2.</span> <span class="toc-text">2. ArchUnit 的原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-ArchUnit-%E4%BD%BF%E7%94%A8%E5%85%A5%E9%97%A8"><span class="toc-number">1.3.3.</span> <span class="toc-text">3. ArchUnit 使用入门</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-4-OWASP-Dependency-Check"><span class="toc-number">1.4.</span> <span class="toc-text">2.1.4 OWASP Dependency-Check</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-%E4%BB%A3%E7%A0%81%E8%AF%84%E5%AE%A1"><span class="toc-number">2.</span> <span class="toc-text">2.2 代码评审</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1-%E4%BB%A3%E7%A0%81%E8%AF%84%E5%AE%A1%E7%9A%84%E5%9C%BA%E6%99%AF"><span class="toc-number">2.1.</span> <span class="toc-text">2.2.1 代码评审的场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-2-%E4%BB%A3%E7%A0%81%E8%AF%84%E5%AE%A1%E7%9A%84%E5%B7%A5%E5%85%B7"><span class="toc-number">2.2.</span> <span class="toc-text">2.2.2 代码评审的工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-3-%E4%BB%A3%E7%A0%81%E8%AF%84%E5%AE%A1%E7%9A%84%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-number">2.3.</span> <span class="toc-text">2.2.3 代码评审的注意事项</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E6%AF%8F%E6%97%A5%E4%BB%A3%E7%A0%81%E8%AF%84%E5%AE%A1"><span class="toc-number">2.3.1.</span> <span class="toc-text">1. 每日代码评审</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%8F%91%E5%B8%83%E5%89%8D%E7%9A%84%E4%BB%A3%E7%A0%81%E8%AF%84%E5%AE%A1"><span class="toc-number">2.3.2.</span> <span class="toc-text">2. 发布前的代码评审</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-Hotfix-%E4%BB%A3%E7%A0%81%E8%AF%84%E5%AE%A1"><span class="toc-number">2.3.3.</span> <span class="toc-text">3. Hotfix 代码评审</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-4-Java-%E4%BB%A3%E7%A0%81%E8%AF%84%E5%AE%A1%E6%B8%85%E5%8D%95"><span class="toc-number">2.4.</span> <span class="toc-text">2.2.4 Java 代码评审清单</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-Git-%E5%B7%A5%E4%BD%9C%E6%B5%81%E5%92%8C%E4%BF%9D%E6%8A%A4"><span class="toc-number">3.</span> <span class="toc-text">2.3 Git 工作流和保护</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-1-Git-%E5%B7%A5%E4%BD%9C%E6%B5%81"><span class="toc-number">3.1.</span> <span class="toc-text">2.3.1 Git 工作流</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-2-Git-Hooks"><span class="toc-number">3.2.</span> <span class="toc-text">2.3.2 Git Hooks</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-3-%E5%88%86%E6%94%AF%E4%BF%9D%E6%8A%A4"><span class="toc-number">3.3.</span> <span class="toc-text">2.3.3 分支保护</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-%E5%B0%8F%E7%BB%93"><span class="toc-number">4.</span> <span class="toc-text">2.4 小结</span></a></li></ol></div></div></div></div></main><footer id="footer" style="background: transparent"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By 山麋一笑</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><div id="runtime"></div></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.12.0"></script><script src="/js/main.js?v=4.12.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.32/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@5.2.0/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(() => {
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://twik.bojiboqi.fun/',
      region: '',
      onCommentLoaded: () => {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') setTimeout(init,0)
    else getScript('https://cdn.jsdelivr.net/npm/twikoo@1.6.29/dist/twikoo.all.min.js').then(init)
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://twik.bojiboqi.fun/',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else {
      loadTwikoo()
      
    }
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script></div><script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.7.1/jquery.js"></script><div class="aplayer no-destroy" data-id="2914905159" data-server="netease" data-type="playlist" data-fixed="true" data-mini="true" data-listFolded="false" data-order="random" data-preload="auto" data-autoplay="true" muted></div><script  async data-pjax="" defer="" src="/js/fish.js"></script><script async src="/js/diytitle.js"></script><script async src="/js/runtime.js"></script><script async src="/js/leaf.js"></script><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/fireworks.min.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/canvas-nest.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/metingjs/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show","#web_bg",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener
  btf.removeGlobalFnEvent('pjax')
  btf.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=4.12.0"></script></div></div></body></html>